<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Controle de Ganhos CDI ‚Äî Layout Empilhado (Com Login)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <!-- Bibliotecas auxiliares -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --primary: #0A0A33;
      --primary-light: #1A1A55;
      --secondary: #C00000;
      --secondary-light: #E00000;
      --danger: #c62828;
      --bg-start: #f4f8fb;
      --bg-end: #eef6fb;
      --card-bg: #ffffff;
      --card-border: rgba(0,0,0,0.06);
      --text-dark: #0f1724;
      --muted: #6b7280;
      --success: #2e7d32;
      --gap: 12px;
      --radius: 10px;
      --shadow: 0 8px 20px rgba(16,24,40,0.06);
    }
    html,body {height:100%;margin:0;font-family:Inter, Roboto, system-ui, -apple-system, "Segoe UI", Arial;}
    body {background:linear-gradient(180deg,var(--bg-start),var(--bg-end));color:var(--text-dark);padding:calc(var(--gap)*1.2);font-size:14px;}
    #siteLogo {display:block;max-width:140px;width:100%;height:auto;border-radius:6px;box-shadow:var(--shadow);margin:0 0 6px 0;}
    #logo-wrapper {margin-bottom:8px;}
    #header-container {display:flex;align-items:center;gap:10px;margin-bottom:8px;width:fit-content;}
    #logo-placeholder {font-size:1.4rem;color:var(--primary);}
    h1 {margin:0;color:var(--text-dark);font-size:1.25rem;font-weight:700;}
    .btn {display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.2s ease;background:var(--primary);color:white;border:1px solid white;}
    .btn.secondary {background:var(--secondary);}
    .btn.small {padding:6px 10px;font-size:13px;border-radius:7px;}
    .btn:hover {transform:translateY(-2px);background:var(--primary-light);}
    .btn.secondary:hover {background:var(--secondary-light);}
    .btn.danger {background:var(--secondary);}
    .card {background:var(--card-bg);padding:14px;border-radius:10px;box-shadow:var(--shadow);border:1px solid var(--card-border);}
    input[type="text"],input[type="date"],input[type="password"] {padding:8px 10px;border-radius:8px;border:1px solid rgba(15,23,36,0.06);}
    .totals {display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:12px;}
    .total-card h4 {margin:0;font-size:12px;color:var(--muted);}
    .total-card p {margin:6px 0 0;font-size:18px;font-weight:800;}
    #totalCdiDisplay p {color:var(--success)!important;}
    table {width:100%;border-collapse:collapse;margin-top:8px;font-size:13px;}
    thead th {background:linear-gradient(180deg,var(--primary-light),var(--primary));color:white;padding:10px 8px;}
    tbody td {padding:8px;border-bottom:1px solid rgba(0,0,0,0.04);text-align:right;}
    tbody tr:nth-child(even){background:rgba(0,0,0,0.02);}
    .col-left {text-align:left;color:var(--primary);font-weight:600;}
    .ganho {color:var(--success)!important;background:rgba(46,125,50,0.1);border:1px solid rgba(46,125,50,0.2);}
    .perda {color:var(--danger)!important;background:rgba(198,40,40,0.1);border:1px solid rgba(198,40,40,0.2);}
  </style>
</head>
<body onload="loadState()">
  <!-- Logo e t√≠tulo -->
  <div id="logo-wrapper">
    <img id="siteLogo" alt="Logo do site">
  </div>
  <div id="header-container">
    <div id="logo-placeholder">üìà</div>
    <h1>Controle de Ganhos CDI</h1>
  </div>

  <!-- Painel de login -->
  <div id="auth-panel" class="card" style="max-width:400px;margin:20px auto;padding:20px;display:none;">
    <h2>Login de Acesso</h2>
    <div style="margin-bottom:10px;">
      <label for="emailInput">E-mail</label>
      <input type="text" id="emailInput" placeholder="seu@email.com" style="width:100%;">
    </div>
    <div style="margin-bottom:15px;">
      <label for="passwordInput">Senha</label>
      <input type="password" id="passwordInput" placeholder="******" style="width:100%;">
    </div>
    <button id="loginBtn" class="btn" style="width:100%;">Entrar</button>
    <p id="auth-error" style="color:var(--danger);font-size:12px;margin-top:10px;"></p>
    <button id="registerBtn" class="btn small secondary" style="margin-top:10px;width:100%;">Criar Conta</button>
  </div>

  <!-- Barra de a√ß√µes superiores -->
  <div id="top-actions" class="card" style="display:none;">
    <button id="logoutBtn" class="btn small danger">Sair</button>
  </div>
  <!-- Conte√∫do principal -->
  <div id="main-container" style="display:none;">
    <!-- Painel de resultados -->
    <div id="results-panel" class="card">
      <h2>üìä Resumo Di√°rio</h2>
      <div class="totals">
        <div class="total-card" id="totalCompromissadaDisplay"><h4>Compromissada TOTAL</h4><p>R$ 0,00</p></div>
        <div class="total-card" id="totalRetornoDisplay"><h4>Retorno Bruto TOTAL</h4><p>R$ 0,00</p></div>
        <div class="total-card" id="totalCdiDisplay"><h4>Ganho (R$) TOTAL</h4><p>R$ 0,00</p></div>
      </div>
      <div class="table-wrap">
        <div id="resultTable"></div>
      </div>
      <p style="font-size:12px;color:var(--muted);margin-top:10px;">
        ‚ö†Ô∏è O <strong>Ganho (R$) Di√°rio</strong> √© calculado pelo Valor Retorno Bruto - Valor Compromissada, com invers√£o para RECOMPRA.
      </p>
    </div>

    <!-- Painel de entrada -->
    <div id="input-panel" class="card">
      <h3>‚ûï Lan√ßamento Manual</h3>
      <input type="hidden" id="editIndex" value="-1">
      <div style="display:flex;flex-direction:column;gap:8px;">
        <div><label for="manualData">Data</label><br><input type="date" id="manualData" required></div>
        <div><label for="manualDesc">Descri√ß√£o</label><br><input type="text" id="manualDesc" placeholder="Ex: REVENDA - Aplica√ß√£o M√™s"></div>
        <div><label for="manualBanco">Banco</label><br><input type="text" id="manualBanco" placeholder="Ex: BTG Pactual"></div>
        <div style="display:flex;gap:8px;">
          <div style="flex:1;"><label for="manualCedente">Conta Cedente</label><br><input type="text" id="manualCedente"></div>
          <div style="flex:1;"><label for="manualCessionario">Conta Cession√°rio</label><br><input type="text" id="manualCessionario"></div>
        </div>
        <div><label for="manualCdiTaxa">Taxa CDI Anual (%)</label><br><input type="text" id="manualCdiTaxa"></div>
        <div style="display:flex;gap:8px;">
          <div style="flex:1;"><label for="manualCompromissada">Valor Compromissada</label><br><input type="text" id="manualCompromissada"></div>
          <div style="flex:1;"><label for="manualRetorno">Valor Retorno</label><br><input type="text" id="manualRetorno"></div>
        </div>
        <div style="display:flex;gap:8px;">
          <button id="addBtn" class="btn" style="flex:1;">Adicionar Lan√ßamento</button>
          <button id="cancelEditBtn" class="btn secondary" style="flex:1;display:none;">Cancelar Edi√ß√£o</button>
        </div>
      </div>
      <pre id="log" style="height:84px;overflow:auto;margin-top:12px;color:var(--muted);">Aguardando...</pre>
      <button id="deleteAllBtn" class="btn small secondary danger" style="margin-top:10px;">üóëÔ∏è Excluir Tudo</button>
    </div>
  </div>
  <script>
    // Configura√ß√£o Firebase
   <script>
  // Configura√ß√£o Firebase (copiada do console e ajustada para v8)
  const firebaseConfig = {
    apiKey: "AIzaSyD_vxw2VcSPO_tMXgrl7quZ85ODvpqQuR8",
    authDomain: "controle-cdi.firebaseapp.com",
    projectId: "controle-cdi",
    storageBucket: "controle-cdi.appspot.com",   // ‚ö†Ô∏è corrigido para .appspot.com
    messagingSenderId: "215359645646",
    appId: "1:215359645646:web:6759dd7485f63df222ad9f",
    measurementId: "G-GM0VBY5Y1M"
  };

  // Inicializa Firebase com sintaxe v8
  firebase.initializeApp(firebaseConfig);

  // Servi√ßo de autentica√ß√£o
  const auth = firebase.auth();
    // Elementos
    const authPanel = document.getElementById('auth-panel');
    const mainContainer = document.getElementById('main-container');
    const topActions = document.getElementById('top-actions');
    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const authError = document.getElementById('auth-error');

    // Fun√ß√µes de visibilidade
    function showAuthPanel() {
      authPanel.style.display = 'block';
      mainContainer.style.display = 'none';
      topActions.style.display = 'none';
    }
    function showAppContent() {
      authPanel.style.display = 'none';
      mainContainer.style.display = 'flex';
      topActions.style.display = 'flex';
    }

    // Login
    if (loginBtn) {
      loginBtn.addEventListener('click', () => {
        const email = emailInput.value;
        const password = passwordInput.value;
        authError.textContent = '';
        auth.signInWithEmailAndPassword(email, password)
          .then(userCredential => {
            log(`‚úÖ Usu√°rio ${userCredential.user.email} logado.`);
          })
          .catch(error => {
            authError.textContent = `‚ùå Erro de Login: ${error.message}`;
          });
      });
    }

    // Registro
    if (registerBtn) {
      registerBtn.addEventListener('click', () => {
        const email = emailInput.value;
        const password = passwordInput.value;
        authError.textContent = '';
        auth.createUserWithEmailAndPassword(email, password)
          .then(userCredential => {
            log(`üéâ Usu√°rio ${userCredential.user.email} registrado e logado.`);
          })
          .catch(error => {
            authError.textContent = `‚ùå Erro de Registro: ${error.message}`;
          });
      });
    }

    // Logout
    if (logoutBtn) {
      logoutBtn.addEventListener('click', () => {
        auth.signOut().then(() => {
          log('üëã Usu√°rio deslogado.');
        }).catch(error => {
          console.error('Erro ao deslogar:', error);
        });
      });
    }

    // Controle de sess√£o
    auth.onAuthStateChanged(user => {
      if (user) {
        showAppContent();
        loadStateContent();
      } else {
        showAuthPanel();
        document.getElementById('resultTable').innerHTML = '';
        document.querySelector('#totalCdiDisplay p').textContent = 'R$ 0,00';
      }
    });

    // Fun√ß√£o de log
    function log(message) {
      document.getElementById('log').textContent = message;
    }
    /* ============================================================
       Fun√ß√µes utilit√°rias e l√≥gica de persist√™ncia/renderiza√ß√£o
    ============================================================ */

    // Reset do tema
    function resetThemeToFixed() {
      document.documentElement.style.setProperty('--primary', '#0A0A33');
      document.documentElement.style.setProperty('--primary-light', '#1A1A55');
      document.documentElement.style.setProperty('--secondary', '#C00000');
      document.documentElement.style.setProperty('--secondary-light', '#E00000');
    }

    // Persist√™ncia
    let operacoes = [], totalCompromissada=0, totalRetorno=0, totalGanho=0;
    function saveState() {
      const uid = auth.currentUser ? auth.currentUser.uid : 'anon';
      try {
        const state = {
          operacoes,
          taxaCdiAnual: document.getElementById('taxaCdiAnual')?.value || '14,90',
          diasAno: document.getElementById('diasAno')?.value || '252'
        };
        localStorage.setItem(`cdiControlState_${uid}`, JSON.stringify(state));
      } catch(e) { console.warn(e); }
    }

    // Carregar estado
    window.loadStateContent = () => {
      resetThemeToFixed();
      const uid = auth.currentUser ? auth.currentUser.uid : 'anon';
      try {
        const s = localStorage.getItem(`cdiControlState_${uid}`);
        if (s) {
          const st = JSON.parse(s);
          operacoes = st.operacoes || [];
          document.getElementById('taxaCdiAnual').value = st.taxaCdiAnual || '14,90';
          document.getElementById('diasAno').value = st.diasAno || '252';
          log(`üíæ ${operacoes.length} opera√ß√µes carregadas para o usu√°rio ${uid}.`);
        } else {
          operacoes = [];
          log('Aguardando... N√£o h√° dados salvos para este usu√°rio.');
        }
      } catch(e) { operacoes=[]; log('‚ùå Erro ao carregar dados.'); }
      calculateAndRender();
    };

    window.loadState = () => { resetThemeToFixed(); };

    // Fun√ß√µes de formata√ß√£o
    function cleanCurrency(v){ if(typeof v!=='string') v=String(v); let s=v.replace(/[R$\s]/g,'').replace(/\./g,'').replace(/,/g,'.'); const n=parseFloat(s); return isNaN(n)?0:n; }
    function parseNumber(v){ if(!v) return 0; if(typeof v==='string' && (v.includes(',')||v.includes('R$'))) return cleanCurrency(v); const n=parseFloat(v); return isNaN(n)?0:n; }
    function cleanCdiTaxa(v){ if(!v) return 0; if(typeof v!=='string') v=String(v); v=v.replace(/[^0-9,.]/g,''); let c=v.replace(',','.'); const n=parseFloat(c); return isNaN(n)?0:n; }
    function formatBRL(n){ return n.toLocaleString('pt-BR',{style:'currency',currency:'BRL',minimumFractionDigits:2}); }
    function formatPercent(n){ return isNaN(n)?'':n.toFixed(4).replace('.',','); }
    function formatPU(n){ return isNaN(n)||n===0?'-':n.toLocaleString('pt-BR',{minimumFractionDigits:4,maximumFractionDigits:4}); }
    function formatDataBR(s){ if(!s) return '-'; if(s.match(/^\d{4}-\d{2}-\d{2}$/)){ const [y,m,d]=s.split('-'); return `${d}/${m}/${y}`; } const d=new Date(s); return !isNaN(d)?d.toLocaleDateString('pt-BR'):s; }
    function normalizeDate(s){ if(!s) return ''; s=String(s).trim(); if(s.match(/^\d{4}-\d{2}-\d{2}$/)) return s; if(s.match(/^\d{2}\/\d{2}\/\d{4}$/)){ const [d,m,y]=s.split('/'); return `${y}-${m}-${d}`; } try{ const d=new Date(s); if(!isNaN(d)) return d.toISOString().split('T')[0]; }catch(e){} return ''; }

    // Renderiza√ß√£o
    function updateTotalCards(){
      document.querySelector('#totalCompromissadaDisplay p').textContent = formatBRL(totalCompromissada);
      document.querySelector('#totalRetornoDisplay p').textContent = formatBRL(totalRetorno);
      document.querySelector('#totalCdiDisplay p').textContent = formatBRL(totalGanho);
    }

    function calculateAndRender(){
      totalCompromissada=0; totalRetorno=0; totalGanho=0;
      const cdiGlobal = cleanCdiTaxa(document.getElementById('taxaCdiAnual')?.value || '14,90');
      const diasAno = parseNumber(document.getElementById('diasAno')?.value || 252);
      let html = "<table><thead><tr><th>Data</th><th>Descri√ß√£o</th><th>Banco</th><th>Cedente</th><th>Cession√°rio</th><th>Compromissada</th><th>Retorno</th><th>Taxa CDI</th><th>Ganho</th><th>A√ß√µes</th></tr></thead><tbody>";
      operacoes.forEach((op,i)=>{
        const comp=parseNumber(op.compromissada), ret=parseNumber(op.retorno);
        const ganho=(ret-comp);
        totalCompromissada+=comp; totalRetorno+=ret; totalGanho+=ganho;
        const ganhoClass=ganho>0?'ganho':ganho<0?'perda':'';
        html+=`<tr><td>${formatDataBR(op.data)}</td><td class="col-left">${op.descricao||'-'}</td><td>${op.banco||'-'}</td><td>${op.contaCedente||'-'}</td><td>${op.contaCessionario||'-'}</td><td>${formatBRL(comp)}</td><td>${formatBRL(ret)}</td><td>${formatPercent(cdiGlobal)}</td><td class="${ganhoClass}">${formatBRL(ganho)}</td><td><button class="btn small" onclick="editOperation(${i})">Alterar</button><button class="btn small secondary danger" onclick="deleteOperation(${i})">Excluir</button></td></tr>`;
      });
      html+="</tbody></table>";
      document.getElementById('resultTable').innerHTML=html;
      updateTotalCards();
      saveState();
    }
    /* ============================================================
       CRUD de opera√ß√µes
    ============================================================ */

    // Adicionar opera√ß√£o
    function addOperation() {
      const data = document.getElementById('manualData').value;
      const desc = document.getElementById('manualDesc').value;
      const comp = document.getElementById('manualCompromissada').value;
      const ret = document.getElementById('manualRetorno').value;

      if (!data || !desc || !comp || !ret) {
        alert('Preencha os campos obrigat√≥rios (Data, Descri√ß√£o, Compromissada e Retorno).');
        return;
      }

      const newOp = {
        data, descricao: desc,
        banco: document.getElementById('manualBanco').value,
        contaCedente: document.getElementById('manualCedente').value,
        contaCessionario: document.getElementById('manualCessionario').value,
        cdiTaxa: document.getElementById('manualCdiTaxa').value,
        compromissada: comp,
        retorno: ret
      };

      const editIndex = parseInt(document.getElementById('editIndex').value);
      if (editIndex > -1) {
        operacoes[editIndex] = newOp;
        document.getElementById('editIndex').value = '-1';
        document.getElementById('addBtn').textContent = 'Adicionar Lan√ßamento';
        document.getElementById('cancelEditBtn').style.display = 'none';
        log('‚úÖ Lan√ßamento alterado com sucesso.');
      } else {
        operacoes.push(newOp);
        log('‚úÖ Lan√ßamento adicionado com sucesso.');
      }

      // Limpar formul√°rio
      document.querySelectorAll('#input-panel input[type="text"], #input-panel input[type="date"]').forEach(input => input.value = '');
      calculateAndRender();
    }
    document.getElementById('addBtn').addEventListener('click', addOperation);

    // Excluir opera√ß√£o
    function deleteOperation(index) {
      if (confirm('Tem certeza que deseja excluir esta opera√ß√£o?')) {
        operacoes.splice(index, 1);
        calculateAndRender();
        log('üóëÔ∏è Opera√ß√£o exclu√≠da.');
      }
    }
    window.deleteOperation = deleteOperation;

    // Editar opera√ß√£o
    function editOperation(index) {
      const op = operacoes[index];
      document.getElementById('manualData').value = normalizeDate(op.data);
      document.getElementById('manualDesc').value = op.descricao;
      document.getElementById('manualBanco').value = op.banco;
      document.getElementById('manualCedente').value = op.contaCedente;
      document.getElementById('manualCessionario').value = op.contaCessionario;
      document.getElementById('manualCdiTaxa').value = op.cdiTaxa;
      document.getElementById('manualCompromissada').value = op.compromissada;
      document.getElementById('manualRetorno').value = op.retorno;

      document.getElementById('editIndex').value = index;
      document.getElementById('addBtn').textContent = 'Salvar Altera√ß√£o';
      document.getElementById('cancelEditBtn').style.display = 'inline-flex';
      log('üìù Modo de Edi√ß√£o Ativo.');
    }
    window.editOperation = editOperation;

    // Cancelar edi√ß√£o
    document.getElementById('cancelEditBtn').addEventListener('click', () => {
      document.getElementById('editIndex').value = '-1';
      document.getElementById('addBtn').textContent = 'Adicionar Lan√ßamento';
      document.getElementById('cancelEditBtn').style.display = 'none';
      document.querySelectorAll('#input-panel input[type="text"], #input-panel input[type="date"]').forEach(input => input.value = '');
      log('‚ùå Edi√ß√£o cancelada.');
    });

    // Excluir tudo
    document.getElementById('deleteAllBtn').addEventListener('click', () => {
      if (confirm('ATEN√á√ÉO: Voc√™ tem certeza que deseja excluir TODAS as opera√ß√µes salvas? Essa a√ß√£o n√£o pode ser desfeita.')) {
        operacoes = [];
        calculateAndRender();
        log('üóëÔ∏è Todos os dados foram exclu√≠dos.');
      }
    });
  </script>
</body>
</html>


<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <title>Controle de Ganhos CDI ‚Äî Layout Empilhado</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        :root{
            /* CORES PRINCIPAIS: AZUL MARINHO ESCURO PRIM√ÅRIO, VERMELHO SECUND√ÅRIO */
            --primary: #0A0A33;  /* Azul Marinho Escuro */
            --primary-light: #1A1A55; /* Vers√£o mais clara para gradiente/hover */
            
            --secondary: #C00000; /* Vermelho Forte (Secund√°rio/Destaque) */
            --secondary-light: #E00000; /* Vermelho Claro para gradiente/hover */
            
            --danger: #c62828;  /* Mantido para a√ß√µes de exclus√£o */
            --bg-start: #f4f8fb;
            --bg-end: #eef6fb;
            --card-bg: #ffffff;
            --card-border: rgba(0,0,0,0.06);
            --text-dark: #0f1724;
            --muted: #6b7280;
            --success: #2e7d32;
            --gap: 12px;
            --radius: 10px;
            --shadow: 0 8px 20px rgba(16,24,40,0.06);
        }
        /* Base */
        html,body{height:100%;margin:0;font-family:Inter, Roboto, system-ui, -apple-system, "Segoe UI", Arial;}
        body{
            background: linear-gradient(180deg,var(--bg-start),var(--bg-end));
            color:var(--text-dark);
            padding:calc(var(--gap) * 1.2);
            -webkit-font-smoothing:antialiased;
            font-size:14px;
        }
        
        /* Ajuste do Logo e T√≠tulo para ficarem √† esquerda e alinhados */
        #siteLogo{ 
            display:block; /* Muda para block */
            max-width:140px; 
            width:100%; 
            height:auto; 
            border-radius:6px; 
            box-shadow:var(--shadow); 
            margin:0 0 6px 0; /* Remove margem autom√°tica, alinha √† esquerda */
        }
        #logo-wrapper{ /* Este se torna desnecess√°rio, mas o mantive no HTML abaixo para o logo */
            margin-bottom:8px;
        }
        
        /* Header */
        #header-container{ 
            display:flex; 
            align-items:center; 
            gap:10px; 
            margin-bottom:8px; 
            /* Para manter o cont√™iner √† esquerda se o logo estiver no topo */
            width: fit-content; 
        }
        
        #logo-placeholder{ font-size:1.4rem; color:var(--primary); } 
        h1{ margin:0; color:var(--text-dark); font-size:1.25rem; font-weight:700; }
        
        /* Cont√™iner para logo e t√≠tulo juntos */
        #left-header-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Top actions compacto */
        #top-actions{
            display:flex; align-items:center; gap:10px; padding:10px;
            background:var(--card-bg); border-radius:var(--radius); box-shadow:var(--shadow); border:1px solid var(--card-border);
            flex-wrap:wrap;
        }
        #header-left{ display:flex; align-items:center; gap:10px; }
        #header-right{ margin-left:auto; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

        /* --------------- BOT√ïES S√ìLIDOS COM CONTORNO BRANCO (ESTILO TRAVELEX) --------------- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            
            /* Estilo Padr√£o (AZUL MARINHO): Fundo Primary, Texto Branco, Borda Branca */
            background: var(--primary); /* Fundo Azul Marinho */
            color: white; /* Texto Branco */
            border: 1px solid white; /* Borda Branca S√≥lida */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08); /* Sombra padr√£o */
        }
        /* Estilo Secund√°rio (VERMELHO): Fundo Secondary, Texto Branco, Borda Branca */
        .btn.secondary {
            background: var(--secondary); /* Fundo Vermelho */
            color: white; /* Texto Branco */
            border: 1px solid white; /* Borda Branca S√≥lida */
        }

        .btn.small { 
            padding: 6px 10px; 
            font-size: 13px; 
            border-radius: 7px; 
        }

        .btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); 
            background: var(--primary-light); /* Ligeiramente mais claro no hover */
            border-color: white; /* Mant√©m a borda branca */
        }
        .btn.secondary:hover {
            background: var(--secondary-light); /* Ligeiramente mais claro no hover */
            border-color: white; /* Mant√©m a borda branca */
            box-shadow: 0 8px 20px rgba(192, 0, 0, 0.25);
        }

        .btn:active { 
            transform: none; 
            filter: brightness(0.96); 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        /* O bot√£o danger √© usado no delete, mas como voc√™ quer ele VERMELHO (secondary), 
           ele usar√° o estilo .btn.secondary, com uma pequena varia√ß√£o de cor */
        .btn.danger { 
            background: var(--secondary); 
            color: white; 
            border: 1px solid white; 
            box-shadow: 0 4px 10px rgba(198, 40, 40, 0.25);
        }
        .btn.danger:hover { 
            filter: brightness(0.85); 
            border-color: white; 
        }
        /* ----------------------------------------------------------- */


        /* Layout empilhado: resultados em cima, painel embaixo */
        #main-container{
            display:flex;
            flex-direction:column;
            gap:14px;
            align-items:stretch;
        }
        /* Cards */
        .card{
            background:var(--card-bg); padding:14px; border-radius:10px; box-shadow:var(--shadow); border:1px solid var(--card-border);
            color:var(--text-dark);
        }
        /* Inputs */
        .input-row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:8px; }
        .input-row label{ font-size:13px; color:var(--muted); font-weight:600; display:block; margin-bottom:6px; }
        input[type="text"], input[type="date"]{
            padding:8px 10px; border-radius:8px; border:1px solid rgba(15,23,36,0.06); background:#fff; color:var(--text-dark); min-width:120px;
        }
        /* Totals */
        .totals{ display:grid; grid-template-columns: repeat(auto-fit,minmax(160px,1fr)); gap:12px; margin-bottom:12px; }
        .total-card{ padding:10px; border-radius:8px; border:1px solid rgba(15,23,36,0.04); background:linear-gradient(180deg,#fff,#fbfdff); }
        .total-card h4{ margin:0; font-size:12px; color:var(--muted); }
        .total-card p{ margin:6px 0 0 0; font-size:18px; font-weight:800; color:var(--text-dark); }
        /* Ganho total em verde */
        #totalCdiDisplay p { color: var(--success) !important; }
        /* Tabela */
        .table-wrap{ overflow:auto; border-radius:8px; }
        table{ width:100%; border-collapse:collapse; margin-top:8px; font-size:13px; color:var(--text-dark); }
        thead th{
            position:sticky; top:0; z-index:2;
            /* Tira grande agora √© Azul Marinho */
            background: linear-gradient(180deg,var(--primary-light),var(--primary));
            color:white; padding:10px 8px; text-align:left; font-weight:700;
            border-bottom:1px solid rgba(0,0,0,0.06);
        }
        tbody td{ padding:8px 8px; border-bottom:1px solid rgba(0,0,0,0.04); text-align:right; }
        tbody tr:nth-child(even){ background: rgba(0,0,0,0.02); }
        td:first-child, th:first-child{ text-align:center; width:90px; }
        /* Descri√ß√£o/Resumo usa o novo primary (Azul Marinho) */
        .col-left{ 
            text-align:left; 
            max-width:260px; 
            overflow:hidden; 
            text-overflow:ellipsis; 
            white-space:nowrap; 
            color: var(--primary); 
            font-weight: 600;
        }
        /* A√ß√µes compactas */
        .action-cell{ text-align:center; }
        
        /* --------------- GANHO/PERDA (BADGE) E NEGRITO GERAL --------------- */
        /* Estilo de Badge aplicado ao conte√∫do da TD */
        .ganho, .perda { 
            font-weight: 800; 
            padding: 2px 6px; 
            border-radius: 4px; 
            display: inline-block; 
            min-width: 60px; 
            text-align: center;
        }

        .ganho { 
            color: var(--success) !important;
            background: rgba(46, 125, 50, 0.1); 
            border: 1px solid rgba(46, 125, 50, 0.2);
        }

        .perda { 
            color: var(--danger) !important; 
            background: rgba(198, 40, 40, 0.1); 
            border: 1px solid rgba(198, 40, 40, 0.2);
        }
        /* Estilo para b/strong em geral */
        b, strong {
            font-weight: 800; 
            color: var(--primary); /* Negrito no Azul Marinho do tema */
        }
        /* ------------------------------------------------------------------- */


        /* Responsive */
        @media (max-width:980px){
            /* Centraliza em telas pequenas */
            #siteLogo{ max-width:120px; display:block; margin:0 auto 8px; }
            #header-container{ margin-bottom:0; width: 100%; justify-content: center; }
            #left-header-content { justify-content: center; }
            .input-row{ flex-direction:column; align-items:stretch; }
        }
        /* Print */
        @media print{
            body{ background:white; padding:0; color:black; }
            #input-panel .file-label, #input-panel .logo-label, #deleteAllBtn { display:none; }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body onload="loadState()">
    
    <div id="logo-wrapper">
        <img id="siteLogo" alt="Logo do site">
    </div>
    <div id="header-container">
        <div id="left-header-content">
            <div id="logo-placeholder">üìà</div>
            <h1>Controle de Ganhos CDI</h1>
        </div>
    </div>
    <div id="top-actions" class="card" role="region" aria-label="A√ß√µes principais">
        <div id="header-left">
            <div style="font-weight:700;">Resumo Di√°rio</div>
            <div style="font-size:12px;color:var(--muted);">Filtros, importa√ß√£o e a√ß√µes r√°pidas</div>
        </div>
        <div id="header-right">
            <button id="printBtn" class="btn small" title="Imprimir">Imprimir</button>
            
            <button id="exportBtn" class="btn small secondary" title="Exportar">Exportar</button>
            
            <label class="file-label" for="excelFile" title="Selecionar arquivos">
                <input type="file" id="excelFile" accept=".xlsx,.xls,.csv,.txt" multiple>
                <span class="btn small">Procurar</span>
            </label>
            
            <button id="loadExcelBtn" class="btn small secondary" title="Importar arquivos">Importar</button>
            
            <label class="logo-label" for="logoFile" title="Carregar logo">
                <input type="file" id="logoFile" accept="image/*">
                <span class="btn small">Procurar</span>
            </label>
            
            <button id="addLogoBtn" class="btn small secondary" title="Carregar Logo">Carregar Logo</button> 
            
            <button id="removeLogoBtn" class="btn small" title="Remover">Remover</button>
            
            <button id="deleteAllBtn" class="btn small secondary danger" title="Excluir tudo">üóëÔ∏è</button>
        </div>
    </div>
    <div id="main-container">
        <div id="results-panel" class="card">
            <h2 style="margin:0 0 8px 0;">üìä Resumo Di√°rio</h2>
            <div class="card filter-card" style="margin-bottom:10px;">
                <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
                    <div style="font-weight:600;color:var(--muted);">Filtros</div>
                    <div style="font-size:12px;color:var(--muted);">Mostrar detalhe por opera√ß√£o</div>
                </div>
                <div class="input-row" style="margin-top:8px;">
                    <div>
                        <label for="filterStartDate">Data de In√≠cio</label>
                        <input type="date" id="filterStartDate">
                    </div>
                    <div>
                        <label for="filterEndDate">Data de Fim</label>
                        <input type="date" id="filterEndDate">
                    </div>
                    <div style="display:flex;align-items:flex-end;gap:8px;">
                        <button id="filterBtn" class="btn small">Filtrar</button>
                        <button id="resetFilterBtn" class="btn small secondary">Limpar</button>
                    </div>
                </div>
                <div style="margin-top:8px;">
                    <label style="font-weight:600;color:var(--muted)">
                        <input type="checkbox" id="showIndividualOps" checked onchange="calculateAndRender()"> Mostrar Detalhe por Opera√ß√£o
                    </label>
                </div>
            </div>
            <div class="totals">
                <div class="total-card" id="totalCompromissadaDisplay"><h4>Compromissada TOTAL</h4><p>R$ 0,00</p></div>
                <div class="total-card" id="totalRetornoDisplay"><h4>Retorno Bruto TOTAL</h4><p>R$ 0,00</p></div>
                <div class="total-card" id="totalCdiDisplay"><h4>Ganho (R$) TOTAL</h4><p>R$ 0,00</p></div>
            </div>
            <div class="table-wrap">
                <div id="resultTable"></div>
            </div>
            <p style="font-size:12px;color:var(--muted);margin-top:10px;">
                ‚ö†Ô∏è O <strong>Ganho (R$) Di√°rio</strong> √© calculado pelo Valor Retorno Bruto - Valor Compromissada, com invers√£o para RECOMPRA.
            </p>
        </div>
        <div id="input-panel" class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <h3 style="margin:0 0 8px 0;">‚≠ê Configura√ß√£o Global</h3>
            </div>
            <div class="input-row">
                <div>
                    <label for="taxaCdiAnual">Taxa CDI Anual Global (%)</label>
                    <input type="text" id="taxaCdiAnual" placeholder="14,90" value="14,90" onchange="calculateAndRender()">
                </div>
                <div>
                    <label for="diasAno">Dias no Ano</label>
                    <input type="text" id="diasAno" placeholder="252" value="252" onchange="calculateAndRender()">
                </div>
            </div>
            <hr style="border:none;border-top:1px solid rgba(15,23,36,0.04);margin:12px 0;">
            <div>
                <h3 style="margin:0 0 8px 0;">üìÇ Importa√ß√£o</h3>
                <p style="font-size:12px;color:var(--muted);margin:0 0 10px 0;">
                    *O sistema tenta reconhecer os cabe√ßalhos, priorizando 'TX. 252' para a taxa CDI.
                </p>
            </div>
            <hr style="border:none;border-top:1px solid rgba(15,23,36,0.04);margin:12px 0;">
            <div>
                <h3 style="margin:0 0 8px 0;">‚ûï Lan√ßamento Manual</h3>
                <div style="display:flex;flex-direction:column;gap:8px;">
                    <input type="hidden" id="editIndex" value="-1">
                    <div><label for="manualData">Data do Lan√ßamento</label><br><input type="date" id="manualData" required></div>
                    <div><label for="manualDesc">Descri√ß√£o</label><br><input type="text" id="manualDesc" placeholder="Ex: REVENDA - Aplica√ß√£o M√™s"></div>
                    <div><label for="manualBanco">Banco / Contraparte</label><br><input type="text" id="manualBanco" placeholder="Ex: BTG Pactual"></div>
                    <div style="display:flex;gap:8px;">
                        <div style="flex:1;"><label for="manualCedente">Conta Cedente</label><br><input type="text" id="manualCedente" placeholder="8300005"></div>
                        <div style="flex:1;"><label for="manualCessionario">Conta Cession√°rio</label><br><input type="text" id="manualCessionario" placeholder="12000005"></div>
                    </div>
                    <div><label for="manualCdiTaxa">Taxa CDI Anual Espec√≠fica (%)</label><br><input type="text" id="manualCdiTaxa" placeholder="14,90 (Deixar vazio para usar Global)"></div>
                    <div style="display:flex;gap:8px;">
                        <div style="flex:1;"><label for="manualCompromissada">Valor Compromissada</label><br><input type="text" id="manualCompromissada" placeholder="10.000,00"></div>
                        <div style="flex:1;"><label for="manualRetorno">Valor Retorno (Bruto)</label><br><input type="text" id="manualRetorno" placeholder="10.050,25"></div>
                    </div>
                    <div style="display:flex;gap:8px;">
                        <button id="addBtn" class="btn" style="flex:1;">Adicionar Lan√ßamento</button>
                        <button id="cancelEditBtn" class="btn secondary" style="flex:1;display:none;">Cancelar Edi√ß√£o</button>
                    </div>
                </div>
            </div>
            <pre id="log" style="height:84px;overflow:auto;margin-top:12px;color:var(--muted);">Aguardando...</pre>
        </div>
    </div>
    <script>
        /* ---------- Fun√ß√µes utilit√°rias e l√≥gica ---------- */
        function log(message) { document.getElementById('log').textContent = message; }
        
        // Fun√ß√£o para manter o tema fixo no Azul Marinho e Vermelho Secund√°rio com Borda Branca
        function resetThemeToFixed() {
            // Aplica as cores Azul Marinho e Vermelho definidas no CSS :root
            document.documentElement.style.setProperty('--primary', '#0A0A33');
            document.documentElement.style.setProperty('--primary-light', '#1A1A55');
            document.documentElement.style.setProperty('--secondary', '#C00000');
            document.documentElement.style.setProperty('--secondary-light', '#E00000');
            
            // Reaplica o estilo S√ìLIDO com borda branca para bot√µes prim√°rios
            document.querySelectorAll('.btn:not(.secondary):not(.danger)').forEach(b => {
                b.style.background = 'var(--primary)';
                b.style.border = '1px solid white';
                b.style.color = 'white';
            });
            
            // Reaplica o estilo S√ìLIDO com borda branca para bot√µes secund√°rios
            document.querySelectorAll('.btn.secondary').forEach(b => {
                b.style.background = 'var(--secondary)';
                b.style.border = '1px solid white';
                b.style.color = 'white';
            });
            
            // Garante que o danger button est√° com a cor e borda corretas (Vermelho)
            document.querySelectorAll('.btn.danger').forEach(b=>{
                b.style.background = getComputedStyle(document.documentElement).getPropertyValue('--secondary').trim(); // Usa secondary para o vermelho
                b.style.color = '#ffffff';
                b.style.border = '1px solid white';
            });
        }

        /* Compress√£o e extra√ß√£o de cor m√©dia (Mantida apenas para carregar o logo) */
        const logoInput = document.getElementById('logoFile');
        const siteLogo = document.getElementById('siteLogo');
        async function compressImageFile(file, quality = 0.7, maxSize = 600) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ratio = Math.min(1, maxSize / Math.max(img.width, img.height));
                        canvas.width = Math.round(img.width * ratio);
                        canvas.height = Math.round(img.height * ratio);
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        try {
                            const dataUrl = canvas.toDataURL('image/jpeg', quality);
                            resolve(dataUrl);
                        } catch (err) { reject(err); }
                    };
                    img.onerror = reject;
                    img.src = reader.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        if (logoInput) {
            
            // L√≥gica para salvar a imagem quando o arquivo √© selecionado
            logoInput.addEventListener('change', async (e) => {
                const file = e.target.files && e.target.files[0];
                if(!file) return;
                
                try {
                    const compressed = await compressImageFile(file, 0.7, 600);
                    siteLogo.src = compressed;
                    siteLogo.style.display = 'block';
                    localStorage.setItem('cdiLogo', compressed); 
                    log('‚úÖ Logo salvo localmente.');
                } catch (err) {
                    console.error(err);
                    log('‚ùå Erro ao processar o logo.');
                }

                resetThemeToFixed();
            });

             // O bot√£o 'Carregar Logo' apenas aciona o clique no input file
             const addLogoBtn = document.getElementById('addLogoBtn');
             if (addLogoBtn) {
                 addLogoBtn.addEventListener('click', () => {
                     logoInput.click();
                 });
             }
        }
        const removeLogoBtn = document.getElementById('removeLogoBtn');
        if (removeLogoBtn) {
            removeLogoBtn.addEventListener('click', ()=>{
                if(!confirm('Tem certeza que deseja remover logo salvo e restaurar padr√£o?')) return;
                localStorage.removeItem('cdiLogo');
                siteLogo.src = '';
                siteLogo.style.display = 'none';
                resetThemeToFixed();
                log('üóëÔ∏è Logo removido. Tema restaurado.');
            });
        }


        // --- Fun√ß√µes de processamento de dados (mantidas como est√£o) ---
        function cleanCurrency(v){ 
            if(typeof v!=='string') v=String(v); 
            let cleanString = v.replace(/[R$\s]/g, '');
            cleanString = cleanString.replace(/\./g, '');
            cleanString = cleanString.replace(/,/g, '.');
            const n=parseFloat(cleanString); 
            return isNaN(n)?0:n; 
        }

        function parseNumber(v){ 
            if(v===undefined||v===null||v==='') return 0; 
            if(typeof v==='string' && (v.includes(',') || v.includes('R$'))) return cleanCurrency(v); 
            const n=parseFloat(v); 
            return isNaN(n)?0:n; 
        }
        
        function cleanCdiTaxa(v){ 
            if(v===undefined||v===null||v==='') return 0; 
            if(typeof v!=='string') v=String(v); 
            v=v.replace(/[^0-9,.]/g,''); 
            let c=v.replace(',','.'); 
            const parts=c.split('.'); 
            if(parts.length>2) c=parts.slice(0,-1).join('')+'.'+parts.slice(-1); 
            const n=parseFloat(c); 
            return isNaN(n)?0:n; 
        }
        
        function formatBRL(n){ return n.toLocaleString('pt-BR',{style:'currency',currency:'BRL',minimumFractionDigits:2}); }
        function formatPercent(n){ if(n===undefined||n===null||isNaN(n)) return ''; return n.toFixed(4).replace('.',','); }
        function formatPU(n){ if(n===undefined||n===null||isNaN(n)||n===0) return '-'; return n.toLocaleString('pt-BR',{minimumFractionDigits:4,maximumFractionDigits:4}); }
        function formatDataBR(s){ if(!s) return '-'; if(s.match(/^\d{4}-\d{2}-\d{2}$/)){ const [y,m,d]=s.split('-'); return `${d}/${m}/${y}`; } if(s.match(/^\d{2}\/\d{2}\/\d{4}$/)) return s; const d=new Date(s); if(!isNaN(d)) return d.toLocaleDateString('pt-BR'); return s; }
        
        function normalizeDate(s){ 
            if(!s) return ''; 
            s=String(s).trim(); 
            if(s.match(/^\d{4}-\d{2}-\d{2}$/)) return s; 
            if(s.match(/^\d{2}\/\d{2}\/\d{4}$/)){ 
                const [d,m,y]=s.split('/'); 
                return `${y}-${m}-${d}`; 
            } 
            const num=parseFloat(s); 
            if(!isNaN(num) && num>25569 && num<70000){ // Excel serial date
                const base=new Date('1899-12-30'); 
                const date=new Date(base.getTime() + num*24*60*60*1000); 
                if(!isNaN(date)){ 
                    const y=date.getUTCFullYear(); 
                    const m=date.getUTCMonth()+1; 
                    const d=date.getUTCDate(); 
                    const pad=n=>n<10?'0'+n:n; 
                    return `${y}-${pad(m)}-${pad(d)}`; 
                } 
            } 
            try{ const d=new Date(s); if(!isNaN(d)) return d.toISOString().split('T')[0]; }catch(e){} 
            return ''; 
        }
        
        /* Persist√™ncia e estado */
        let operacoes = [], totalCompromissada=0, totalRetorno=0, totalGanho=0;
        function saveState(){ try{ const state={operacoes, taxaCdiAnual:document.getElementById('taxaCdiAnual').value, diasAno:document.getElementById('diasAno').value}; localStorage.setItem('cdiControlState', JSON.stringify(state)); }catch(e){ console.warn(e); } }
        /* Carrega estado e logo salvos */
        window.loadState = ()=>{
            resetThemeToFixed(); // Aplica o tema Azul Marinho e Vermelho Secund√°rio no carregamento
            try{
                const s = localStorage.getItem('cdiControlState');
                if(s){
                    const st = JSON.parse(s);
                    operacoes = st.operacoes || [];
                    document.getElementById('taxaCdiAnual').value = st.taxaCdiAnual || '14,90';
                    document.getElementById('diasAno').value = st.diasAno || '252';
                    log(`üíæ ${operacoes.length} opera√ß√µes carregadas.`);
                } else log('Aguardando... N√£o h√° dados salvos.');
            }catch(e){ operacoes=[]; log('‚ùå Erro ao carregar dados.'); }
            try {
                const savedLogo = localStorage.getItem('cdiLogo');
                if (savedLogo) {
                    siteLogo.src = savedLogo;
                    siteLogo.style.display = 'block';
                    log('üíæ Logo carregado do salvamento local.');
                }
            } catch (err) { console.warn(err); }
            // adiciona listeners de filtro (s√≥ uma vez)
            attachFilterListeners();
            calculateAndRender();
        };
        /* Renderiza√ß√£o */
        function updateTotalCards(){ document.querySelector('#totalCompromissadaDisplay p').textContent = formatBRL(totalCompromissada); document.querySelector('#totalRetornoDisplay p').textContent = formatBRL(totalRetorno); document.querySelector('#totalCdiDisplay p').textContent = formatBRL(totalGanho); }
        function calculateAndRender(){
            totalCompromissada=0; totalRetorno=0; totalGanho=0;
            const cdiGlobal = cleanCdiTaxa(document.getElementById('taxaCdiAnual').value);
            const diasAno = parseNumber(document.getElementById('diasAno').value) || 252;
            const showIndividual = document.getElementById('showIndividualOps').checked;
            
            // LER E NORMALIZAR OS FILTROS
            const filterStartDateStr = document.getElementById('filterStartDate').value;
            const filterEndDateStr = document.getElementById('filterEndDate').value;
            const filterStart = filterStartDateStr ? normalizeDate(filterStartDateStr) : '';
            const filterEnd = filterEndDateStr ? normalizeDate(filterEndDateStr) : '';

            let ops = operacoes.filter(op=>{
                const d = normalizeDate(op.data);
                if(!d) return false;
                if(filterStart && d < filterStart) return false;
                if(filterEnd && d > filterEnd) return false;
                return true;
            });
            ops.sort((a,b)=> normalizeDate(a.data).localeCompare(normalizeDate(b.data)));
            // normaliza exibi√ß√£o dos inputs
            document.getElementById('taxaCdiAnual').value = formatPercent(cdiGlobal);
            document.getElementById('diasAno').value = diasAno;
            let html = "<table><thead><tr><th>Data</th><th>Descri√ß√£o/Resumo</th><th>Banco</th><th>Conta Cedente</th><th>Conta Cession√°rio</th><th>Compromissada</th><th>Retorno Bruto</th><th>PU IDA</th><th>PU VOLTA</th><th>Taxa CDI Anual (%)</th><th>Ganho (R$) Di√°rio</th><th class='action-cell'>A√ß√µes</th></tr></thead><tbody>";
            const resumo = {};
            ops.forEach(op=>{
                const d = normalizeDate(op.data);
                const comp = parseNumber(op.compromissada); 
                const ret = parseNumber(op.retorno);
                const ganho = (ret - comp) * ( (typeof op.descricao === 'string' && op.descricao.toUpperCase().includes('RECOMPRA')) ? -1 : 1 );
                const taxaUsada = (cleanCdiTaxa(op.cdiTaxa) > 0 && cleanCdiTaxa(op.cdiTaxa) !== 100) ? cleanCdiTaxa(op.cdiTaxa) : cdiGlobal;
                totalCompromissada += comp; totalRetorno += ret; totalGanho += ganho;
                if(!resumo[d]) resumo[d] = { data:d, totalCompromissada:0, totalRetorno:0, totalGanho:0, primeiraTaxa: taxaUsada };
                resumo[d].totalCompromissada += comp; resumo[d].totalRetorno += ret; resumo[d].totalGanho += ganho;
                if(showIndividual){
                    const ganhoClass = ganho>0 ? 'ganho' : (ganho<0 ? 'perda' : ''); 
                    html += `<tr class="individual-operation-row">
                        <td class="col-data">${formatDataBR(op.data)}</td>
                        <td class="col-left">${(op.descricao||'-')}</td>
                        <td class="col-left">${(op.banco||'-')}</td>
                        <td>${op.contaCedente||'-'}</td>
                        <td>${op.contaCessionario||'-'}</td>
                        <td>${formatBRL(comp)}</td>
                        <td>${formatBRL(ret)}</td>
                        <td>${formatPU(parseNumber(op.puIda))}</td>
                        <td>${formatPU(parseNumber(op.puVolta))}</td>
                        <td style="text-align:center;">${(Number(taxaUsada)||0).toFixed(4).replace('.',',')}</td>
                        <td class="${ganhoClass}">${formatBRL(ganho)}</td>
                        <td class="action-cell">
                            <button class="btn small" onclick="editOperation(${operacoes.indexOf(op)})">Alterar</button>
                            <button class="btn small secondary" onclick="deleteOperation(${operacoes.indexOf(op)})">Excluir</button>
                        </td>
                    </tr>`;
                }
            });
            const datas = Object.keys(resumo).sort();
            if(showIndividual && datas.length) html += `<tr><td colspan="12" style="text-align:left;background:rgba(0,0,0,0.02);font-weight:700;">RESUMO DI√ÅRIO (Consolida√ß√£o por dia)</td></tr>`;
            datas.forEach(k=>{
                const r = resumo[k];
                const ganhoClass = r.totalGanho>0 ? 'ganho' : (r.totalGanho<0 ? 'perda' : ''); 
                const taxaExib = (cleanCdiTaxa(r.primeiraTaxa) > 0 ? r.primeiraTaxa : cleanCdiTaxa(document.getElementById('taxaCdiAnual').value));
                html += `<tr class="daily-summary-row">
                    <td class="col-data">${formatDataBR(r.data)}</td>
                    <td class="col-left">Soma Di√°ria</td>
                    <td class="col-left">-</td><td>-</td><td>-</td>
                    <td>${formatBRL(r.totalCompromissada)}</td>
                    <td>${formatBRL(r.totalRetorno)}</td>
                    <td>-</td><td>-</td><td style="text-align:center;">${(Number(taxaExib)||0).toFixed(4).replace('.',',')}</td>
                    <td class="${ganhoClass}">${formatBRL(r.totalGanho)}</td>
                    <td class="action-cell">-</td>
                </tr>`;
            });
            const totalClass = totalGanho>0 ? 'ganho' : (totalGanho<0 ? 'perda' : '');
            html += `<tr class="total-row">
                <td colspan="5">TOTAL GERAL</td>
                <td>${formatBRL(totalCompromissada)}</td>
                <td>${formatBRL(totalRetorno)}</td>
                <td>-</td><td>-</td><td>-</td>
                <td class="${totalClass}" style="font-weight:800;">${formatBRL(totalGanho)}</td>
                <td class="action-cell"></td>
            </tr>`;
            html += "</tbody></table>";
            document.getElementById('resultTable').innerHTML = html;
            updateTotalCards();
            saveState();
            log(`‚úÖ ${ops.length} opera√ß√µes exibidas em ${datas.length} dias.`);
        }
        /* Edi√ß√£o / exclus√£o / listeners (mantidos) */
        function editOperation(index){
            const op = operacoes[index];
            document.getElementById('manualData').value = normalizeDate(op.data);
            document.getElementById('manualDesc').value = op.descricao || '';
            document.getElementById('manualBanco').value = op.banco || '';
            document.getElementById('manualCedente').value = op.contaCedente || '';
            document.getElementById('manualCessionario').value = op.contaCessionario || '';
            document.getElementById('manualCompromissada').value = formatNumberToDisplay(parseNumber(op.compromissada));
            document.getElementById('manualRetorno').value = formatNumberToDisplay(parseNumber(op.retorno));
            document.getElementById('manualCdiTaxa').value = op.cdiTaxa ? String(op.cdiTaxa).replace('.',',') : '';
            document.getElementById('editIndex').value = index;
            document.getElementById('addBtn').textContent = 'Salvar Altera√ß√£o';
            document.getElementById('cancelEditBtn').style.display = 'inline-block';
            log(`üìù Editando √≠ndice ${index}.`);
            document.getElementById('manualData').scrollIntoView({behavior:'smooth'});
        }
        function deleteOperation(index){
            if(!confirm('Tem certeza que deseja excluir este lan√ßamento?')) return;
            operacoes.splice(index,1);
            calculateAndRender();
            log('üóëÔ∏è Lan√ßamento exclu√≠do.');
        }
        /* Add / cancel */
        function formatNumberToDisplay(number){ if(number===undefined||number===null||isNaN(number)) return ''; return number.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2}); }
        document.getElementById('addBtn').addEventListener('click', ()=>{
            const idx = parseInt(document.getElementById('editIndex').value || '-1',10);
            const data = document.getElementById('manualData').value;
            const desc = document.getElementById('manualDesc').value || 'Lan√ßamento Manual';
            const banco = document.getElementById('manualBanco').value || '';
            const ced = document.getElementById('manualCedente').value || '';
            const cession = document.getElementById('manualCessionario').value || '';
            const comp = document.getElementById('manualCompromissada').value;
            const ret = document.getElementById('manualRetorno').value;
            const taxa = document.getElementById('manualCdiTaxa').value || '';
            if(!data || !comp || !ret){ alert('Preencha Data, Compromissada e Retorno Bruto.'); return; }
            const obj = { data: normalizeDate(data), descricao: desc, banco, contaCedente: ced, contaCessionario: cession, compromissada: comp, retorno: ret, cdiTaxa: taxa, puIda:'', puVolta:'' };
            if(idx > -1){ operacoes[idx] = { ...operacoes[idx], ...obj }; log(`‚úèÔ∏è Lan√ßamento ${idx} atualizado.`); document.getElementById('cancelEditBtn').click(); }
            else { operacoes.push(obj); log('‚ûï Lan√ßamento adicionado.'); document.getElementById('manualData').value=''; document.getElementById('manualDesc').value=''; document.getElementById('manualBanco').value=''; document.getElementById('manualCedente').value=''; document.getElementById('manualCessionario').value=''; document.getElementById('manualCompromissada').value=''; document.getElementById('manualRetorno').value=''; document.getElementById('manualCdiTaxa').value=''; }
            calculateAndRender();
        });
        document.getElementById('cancelEditBtn').addEventListener('click', ()=>{
            document.getElementById('editIndex').value='-1';
            document.getElementById('manualData').value=''; document.getElementById('manualDesc').value=''; document.getElementById('manualBanco').value=''; document.getElementById('manualCedente').value=''; document.getElementById('manualCessionario').value=''; document.getElementById('manualCompromissada').value=''; document.getElementById('manualRetorno').value=''; document.getElementById('manualCdiTaxa').value='';
            document.getElementById('addBtn').textContent='Adicionar Lan√ßamento';
            document.getElementById('cancelEditBtn').style.display='none';
            log('‚ùå Edi√ß√£o cancelada.');
        });
        /* Import / export / print / delete all */
        const fileInput = document.getElementById('excelFile');
        const loadBtn = document.getElementById('loadExcelBtn');
        function attachFilterListeners(){
            document.getElementById('filterBtn').addEventListener('click', calculateAndRender);
            document.getElementById('resetFilterBtn').addEventListener('click', ()=>{
                document.getElementById('filterStartDate').value = '';
                document.getElementById('filterEndDate').value = '';
                calculateAndRender();
            });
            document.getElementById('printBtn').addEventListener('click', ()=>window.print());
            document.getElementById('deleteAllBtn').addEventListener('click', ()=>{
                if(!confirm('Tem certeza que deseja EXCLUIR TODOS os lan√ßamentos? Esta a√ß√£o n√£o pode ser desfeita.')) return;
                operacoes = [];
                localStorage.removeItem('cdiControlState');
                calculateAndRender();
                log('üí• Todos os dados exclu√≠dos.');
            });
        }
        
        if (loadBtn) loadBtn.disabled = true;
        if (fileInput) {
            fileInput.addEventListener('change', (e)=>{ if (loadBtn) loadBtn.disabled = !(e.target.files && e.target.files.length); if(e.target.files && e.target.files.length) log(`üìÅ ${e.target.files.length} arquivo(s) selecionado(s).`); else log('Aguardando sele√ß√£o de arquivo...'); });
        }
        
        async function loadExcel(file){
            const ext = file.name.split('.').pop().toLowerCase();
            if(ext==='xlsx' || ext==='xls'){
                const data = await file.arrayBuffer();
                const wb = XLSX.read(data,{type:'array'});
                const ws = wb.Sheets[wb.SheetNames[0]];
                return XLSX.utils.sheet_to_json(ws,{header:1,defval:'',raw:true});
            } else {
                return await new Promise((resolve,reject)=>{
                    Papa.parse(file,{header:false,skipEmptyLines:true,delimiter:'auto',encoding:'utf-8',complete:r=>resolve(r.data),error:e=>reject(e)});
                });
            }
        }
        function findColumnIndices(data){
            const headerRow = data.find(row => Array.isArray(row) && row.some(cell => typeof cell === 'string' && (cell.toUpperCase().includes('DT.MOVIMENTO') || cell.toUpperCase().includes('VL IDA') || cell.toUpperCase().includes('TAXA'))));
            if(!headerRow){ log('‚ö†Ô∏è Cabe√ßalho n√£o encontrado. Usando √≠ndices padr√£o.'); return { DATA:8, DESCRICAO:3, TAXA:19, RETORNO:11, COMPROMISSADA:15, BANCO:14, CEDENTE:-1, CESSIONARIO:-1, PU_IDA:-1, PU_VOLTA:-1, dataStartRow:0 }; }
            const headers = headerRow.map(h => typeof h === 'string' ? h.toUpperCase().trim() : '');
            const map = {
                DATA: headers.findIndex(h => h.includes('DT.MOVIMENTO') || h.includes('DT.IN√çCIO') || h==='DATA'),
                TAXA: headers.findIndex(h => h==='TX. 252'),
                DESCRICAO: headers.findIndex(h => h.includes('PAPEL') || h.includes('PRODUTO') || h.includes('TIPO OPERA√á√ÉO')),
                RETORNO: headers.findIndex(h => h.includes('VALOR L√çQUIDO') || h.includes('VL VOLTA') || h==='VALOR'),
                COMPROMISSADA: headers.findIndex(h => h.includes('VL IDA') || h==='VALOR'),
                BANCO: headers.findIndex(h => h.includes('CONTRAPARTE') || h.includes('CLIENTE')),
                CEDENTE: headers.findIndex(h => h.includes('CEDENTE') && h.includes('CONTA')),
                CESSIONARIO: headers.findIndex(h => h.includes('CESSION√ÅRIO') && h.includes('CONTA')),
                PU_IDA: headers.findIndex(h => h.includes('PU IDA')),
                PU_VOLTA: headers.findIndex(h => h.includes('PU VOLTA'))
            };
            const indices = {
                DATA: map.DATA > -1 ? map.DATA : 3,
                DESCRICAO: map.DESCRICAO > -1 ? map.DESCRICAO : 1,
                TAXA: map.TAXA > -1 ? map.TAXA : 10,
                RETORNO: map.RETORNO > -1 ? map.RETORNO : 7,
                COMPROMISSADA: map.COMPROMISSADA > -1 ? map.COMPROMISSADA : 6,
                BANCO: map.BANCO > -1 ? map.BANCO : 2,
                CEDENTE: map.CEDENTE > -1 ? map.CEDENTE : 12,
                CESSIONARIO: map.CESSIONARIO > -1 ? map.CESSIONARIO : 13,
                PU_IDA: map.PU_IDA > -1 ? map.PU_IDA : 4,
                PU_VOLTA: map.PU_VOLTA > -1 ? map.PU_VOLTA : 5,
                dataStartRow: data.indexOf(headerRow) > -1 ? data.indexOf(headerRow) + 1 : 0
            };
            log(`Mapeamento: Data=${indices.DATA}, Comp=${indices.COMPROMISSADA}, Ret=${indices.RETORNO}, Taxa=${indices.TAXA}.`);
            return indices;
        }
        function processExcel(data){
            if(!data || data.length<1){ log('‚ùå Arquivo vazio.'); return []; }
            const indices = findColumnIndices(data);
            const start = indices.dataStartRow || 0;
            let valid=0; const newOps = [];
            for(let i=start; i<data.length; i++){
                const row = data[i];
                const rawComp = row[indices.COMPROMISSADA];
                const rawRet = row[indices.RETORNO];
                const rawData = row[indices.DATA];
                // Ignorar linhas sem compromissada ou retorno v√°lidos
                if(parseNumber(rawComp) === 0 && parseNumber(rawRet) === 0) continue; 
                
                const dataFormatada = normalizeDate(rawData);
                if(!dataFormatada) continue; // Ignorar linhas sem data v√°lida
                
                newOps.push({
                    data: dataFormatada,
                    descricao: String(row[indices.DESCRICAO] || ''),
                    banco: String(row[indices.BANCO] || ''),
                    contaCedente: String(row[indices.CEDENTE] || ''),
                    contaCessionario: String(row[indices.CESSIONARIO] || ''),
                    compromissada: String(rawComp || ''),
                    retorno: String(rawRet || ''),
                    cdiTaxa: String(row[indices.TAXA] || ''),
                    puIda: String(row[indices.PU_IDA] || ''),
                    puVolta: String(row[indices.PU_VOLTA] || '')
                });
                valid++;
            }
            log(`‚úÖ ${valid} opera√ß√µes v√°lidas encontradas e prontas para importa√ß√£o.`);
            return newOps;
        }
        
        loadExcelBtn.addEventListener('click', async () => {
            const files = fileInput.files;
            if (files.length === 0) return;
            
            log(`‚è≥ Processando ${files.length} arquivo(s)...`);
            let totalNewOps = [];
            
            for (const file of files) {
                try {
                    const data = await loadExcel(file);
                    const newOps = processExcel(data);
                    totalNewOps = totalNewOps.concat(newOps);
                    log(`üìÅ Arquivo "${file.name}" processado. ${newOps.length} opera√ß√µes encontradas.`);
                } catch (e) {
                    console.error(e);
                    log(`‚ùå Erro ao processar o arquivo "${file.name}".`);
                }
            }
            
            if (totalNewOps.length > 0) {
                operacoes = operacoes.concat(totalNewOps);
                calculateAndRender();
                log(`üéâ Importa√ß√£o conclu√≠da! ${totalNewOps.length} novas opera√ß√µes adicionadas. Total: ${operacoes.length}.`);
            } else {
                log('‚ö†Ô∏è Nenhuma nova opera√ß√£o v√°lida encontrada nos arquivos selecionados.');
            }
            // Limpa os arquivos selecionados
            fileInput.value = '';
            loadBtn.disabled = true;
        });

        document.getElementById('exportBtn').addEventListener('click', () => {
            if(operacoes.length === 0) {
                alert('N√£o h√° dados para exportar.');
                return;
            }

            const header = [
                'Data', 'Descricao', 'Banco', 'Conta Cedente', 'Conta Cessionario', 
                'Compromissada', 'Retorno Bruto', 'PU Ida', 'PU Volta', 'Taxa CDI Anual (%)'
            ];

            const exportData = operacoes.map(op => {
                const taxa = cleanCdiTaxa(op.cdiTaxa);
                return [
                    formatDataBR(op.data),
                    op.descricao,
                    op.banco,
                    op.contaCedente,
                    op.contaCessionario,
                    parseNumber(op.compromissada),
                    parseNumber(op.retorno),
                    parseNumber(op.puIda),
                    parseNumber(op.puVolta),
                    taxa
                ];
            });

            const ws = XLSX.utils.aoa_to_sheet([header, ...exportData]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Ganhos CDI");
            
            const hoje = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            XLSX.writeFile(wb, `Controle_Ganhos_CDI_${hoje}.xlsx`);
            log('üíæ Dados exportados para Excel.');
        });
            <!-- aqui j√° √© o final do seu layout -->

    <!-- Firebase -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";

      const firebaseConfig = {
        apiKey: "AIzaSyD_vxw2VcSPO_tMXgrl7quZ85ODvpqQuR8",
        authDomain: "controle-cdi.firebaseapp.com",
        projectId: "controle-cdi",
        storageBucket: "controle-cdi.firebasestorage.app",
        messagingSenderId: "215359645646",
        appId: "1:215359645646:web:6759dd7485f63df222ad9f",
        measurementId: "G-GM0VBY5Y1M"
      };

      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);

      console.log("Firebase inicializado com sucesso!", app);
    </script>
</body>
</html>
  


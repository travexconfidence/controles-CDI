<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <title>Controle de Ganhos CDI ‚Äî Layout Empilhado (Firebase)</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <style>
        /* Estilos CSS do seu projeto original (Mantidos e Completados com Modal/Loading) */
        :root{
            /* CORES PRINCIPAIS: AZUL MARINHO ESCURO PRIM√ÅRIO, VERMELHO SECUND√ÅRIO */
            --primary: #0A0A33;  /* Azul Marinho Escuro */
            --primary-light: #1A1A55; /* Vers√£o mais clara para gradiente/hover */
            --secondary: #C00000; /* Vermelho Forte (Secund√°rio/Destaque) */
            --secondary-light: #E00000; /* Vermelho Claro para gradiente/hover */
            --danger: #c62828;  /* Mantido para a√ß√µes de exclus√£o */
            --bg-start: #f4f8fb;
            --bg-end: #eef6fb;
            --card-bg: #ffffff;
            --card-border: rgba(0,0,0,0.06);
            --text-dark: #0f1724;
            --muted: #6b7280;
            --success: #2e7d32;
            --gap: 12px;
            --radius: 10px;
            --shadow: 0 8px 20px rgba(16,24,40,0.06);
        }
        /* Base */
        html,body{height:100%;margin:0;font-family:Inter, Roboto, system-ui, -apple-system, "Segoe UI", Arial;}
        body{
            background: linear-gradient(180deg,var(--bg-start),var(--bg-end));
            color:var(--text-dark);
            padding:calc(var(--gap) * 1.2);
            -webkit-font-smoothing:antialiased;
            font-size:14px;
        }
        #siteLogo{ display:block; max-width:140px; width:100%; height:auto; border-radius:6px; box-shadow:var(--shadow); margin:0 0 6px 0; }
        #header-container{ display:flex; align-items:center; gap:10px; margin-bottom:8px; width: fit-content; }
        #logo-placeholder{ font-size:1.4rem; color:var(--primary); } 
        h1{ margin:0; color:var(--text-dark); font-size:1.25rem; font-weight:700; }
        #left-header-content { display: flex; align-items: center; gap: 10px;}
        #top-actions{ display:flex; align-items:center; gap:10px; padding:10px; background:var(--card-bg); border-radius:var(--radius); box-shadow:var(--shadow); border:1px solid var(--card-border); flex-wrap:wrap; }
        #header-left{ display:flex; align-items:center; gap:10px; }
        #header-right{ margin-left:auto; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
        
        /* ESTILO PARA O NOME DO ARQUIVO SELECIONADO */
        #fileNameDisplay {
            padding: 6px 10px;
            font-size: 13px;
            color: var(--primary);
            font-weight: 600;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 7px;
            background: #f0f0f8;
            max-width: 180px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        /* --------------- BOT√ïES S√ìLIDOS COM CONTORNO BRANCO --------------- */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s ease; background: var(--primary); color: white; border: 1px solid white; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08); }
        .btn.secondary { background: var(--secondary); color: white; border: 1px solid white; }
        .btn.small { padding: 6px 10px; font-size: 13px; border-radius: 7px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); background: var(--primary-light); border-color: white; }
        .btn.secondary:hover { background: var(--secondary-light); border-color: white; box-shadow: 0 8px 20px rgba(192, 0, 0, 0.25); }
        .btn:active { transform: none; filter: brightness(0.96); box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); }
        .btn.danger { background: var(--secondary); color: white; border: 1px solid white; box-shadow: 0 4px 10px rgba(198, 40, 40, 0.25); }
        .btn.danger:hover { filter: brightness(0.85); border-color: white; }
        /* ----------------------------------------------------------- */
        /* Layout empilhado: resultados em cima, painel embaixo */
        #main-container{ display:flex; flex-direction:column; gap:14px; align-items:stretch; }
        /* Cards */
        .card{ background:var(--card-bg); padding:14px; border-radius:10px; box-shadow:var(--shadow); border:1px solid var(--card-border); color:var(--text-dark); }
        /* Inputs */
        .input-row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:8px; }
        .input-row label{ font-size:13px; color:var(--muted); font-weight:600; display:block; margin-bottom:6px; }
        input[type="text"], input[type="date"]{ padding:8px 10px; border-radius:8px; border:1px solid rgba(15,23,36,0.06); background:#fff; color:var(--text-dark); min-width:120px; }
        /* Totals */
        .totals{ display:grid; grid-template-columns: repeat(auto-fit,minmax(160px,1fr)); gap:12px; margin-bottom:12px; }
        .total-card{ padding:10px; border-radius:8px; border:1px solid rgba(15,23,36,0.04); background:linear-gradient(180deg,#fff,#fbfdff); }
        .total-card h4{ margin:0; font-size:12px; color:var(--muted); }
        .total-card p{ margin:6px 0 0 0; font-size:18px; font-weight:800; color:var(--text-dark); }
        /* Ganho total em verde */
        #totalCdiDisplay p { color: var(--success) !important; }
        /* Tabela */
        .table-wrap{ overflow:auto; border-radius:8px; }
        table{ width:100%; border-collapse:collapse; margin-top:8px; font-size:13px; color:var(--text-dark); }
        thead th{ position:sticky; top:0; z-index:2; background: linear-gradient(180deg,var(--primary-light),var(--primary)); color:white; padding:10px 8px; text-align:left; font-weight:700; border-bottom:1px solid rgba(0,0,0,0.06); }
        tbody td{ padding:8px 8px; border-bottom:1px solid rgba(0,0,0,0.04); text-align:right; }
        tbody tr:nth-child(even){ background: rgba(0,0,0,0.02); }
        td:first-child, th:first-child{ text-align:center; width:90px; }
        .col-left{ text-align:left; max-width:260px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; color: var(--primary); font-weight: 600;}
        /* A√ß√µes compactas */
        .action-cell{ text-align:center; }
        /* --------------- GANHO/PERDA (BADGE) E NEGRITO GERAL --------------- */
        .ganho, .perda { font-weight: 800; padding: 2px 6px; border-radius: 4px; display: inline-block; min-width: 60px; text-align: center;}
        .ganho { color: var(--success) !important; background: rgba(46, 125, 50, 0.1); border: 1px solid rgba(46, 125, 50, 0.2); }
        .perda { color: var(--danger) !important; background: rgba(198, 40, 40, 0.1); border: 1px solid rgba(198, 40, 40, 0.2); }
        b, strong { font-weight: 800; color: var(--primary); }
        /* ------------------------------------------------------------------- */
        /* Modal e Loading (Novos Estilos) */
        .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; overflow:auto; background:rgba(0,0,0,0.4); justify-content:center; align-items:center; }
        .modal-content { background:white; padding:20px; border-radius:10px; width:95%; max-width:480px; box-shadow:0 5px 15px rgba(0,0,0,0.3); }
        .modal-content h2 { color:var(--primary); margin-top:0; }
        .modal-content input, .modal-content button { margin-bottom:12px; width:100%; box-sizing:border-box; }
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index:2000; font-size: 18px; font-weight: 600; color: var(--primary); }
        /* Responsive */
        @media (max-width:980px){ #siteLogo{ max-width:120px; display:block; margin:0 auto 8px; } #header-container{ margin-bottom:0; width: 100%; justify-content: center; } #left-header-content { justify-content: center; } .input-row{ flex-direction:column; align-items:stretch; } }
        /* Print */
        @media print{ body{ background:white; padding:0; color:black; } #input-panel .file-label, #input-panel .logo-label, #deleteAllBtn { display:none; } }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body onload="loadState()">

    <div id="loadingOverlay" style="display:none;">Conectando √† Nuvem...</div>

    <div id="loginModal" class="modal" style="display: flex;">
        <div class="modal-content">
            <h2>Acesso Controle CDI</h2>
            <p>Por favor, utilize suas credenciais do Firebase.</p>
            <input type="email" id="loginEmail" placeholder="Email do Usu√°rio">
            <input type="password" id="loginPassword" placeholder="Senha do Usu√°rio">
            <button class="btn secondary" onclick="handleLogin()">Entrar</button>
        </div>
    </div>

    <div id="appContent" style="display:none;">
        <div id="logo-wrapper">
            <img id="siteLogo" alt="Logo do site" style="display:none;">
        </div>
        <div id="header-container">
            <div id="left-header-content">
                <div id="logo-placeholder">üìà</div>
                <h1>Controle de Ganhos CDI</h1>
            </div>
        </div>
        
        <button onclick="handleLogout()" class="btn small danger" style="position: absolute; top: 20px; right: 20px;">Sair</button>

        <div id="top-actions" class="card" role="region" aria-label="A√ß√µes principais">
            <div id="header-left">
                <div style="font-weight:700;">Resumo Di√°rio</div>
                <div style="font-size:12px;color:var(--muted);">Filtros, importa√ß√£o e a√ß√µes r√°pidas</div>
            </div>
            
            <div id="header-right">
                <button id="printBtn" class="btn small" title="Imprimir" onclick="window.print()">Imprimir</button>
                <button id="exportBtn" class="btn small secondary" title="Exportar" onclick="exportExcel()">Exportar</button>
                
                <input type="file" id="excelFile" accept=".xlsx,.xls,.csv,.txt" multiple onchange="selectFile(event)" style="display: none;"> 

                <button id="searchFileBtn" class="btn small secondary" title="Buscar arquivo Excel/CSV" 
                    onclick="document.getElementById('excelFile').click()">
                    Buscar Arquivo
                </button>
                
                <span id="fileNameDisplay" style="display:none;">Nenhum arquivo.</span>

                <button id="importBtn" class="btn small secondary" title="Importar dados selecionados" 
                    onclick="importSelectedFile()" disabled>
                    Importar
                </button>
                
                <input type="file" id="logoFile" accept="image/*" style="display: none;">

                <button id="addLogoBtn" class="btn small secondary" title="Carregar Logo" onclick="document.getElementById('logoFile').click()">Carregar Logo</button>
                <button id="removeLogoBtn" class="btn small" title="Remover" onclick="removeLogo()">Remover</button>
                <button id="deleteAllBtn" class="btn small secondary danger" title="Excluir tudo" onclick="deleteAllData()">üóëÔ∏è</button>
            </div>
            </div>
        
        <div id="main-container">
            <div id="results-panel" class="card">
                <h2 style="margin:0 0 8px 0;">üìä Resumo Di√°rio</h2>
                <div class="card filter-card" style="margin-bottom:10px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
                        <div style="font-weight:600;color:var(--muted);">Filtros</div>
                        <div style="font-size:12px;color:var(--muted);">Mostrar detalhe por opera√ß√£o</div>
                    </div>
                    <div class="input-row" style="margin-top:8px;">
                        <div>
                            <label for="filterStartDate">Data de In√≠cio</label>
                            <input type="date" id="filterStartDate">
                        </div>
                        <div>
                            <label for="filterEndDate">Data de Fim</label>
                            <input type="date" id="filterEndDate">
                        </div>
                        <div style="display:flex;align-items:flex-end;gap:8px;">
                            <button id="filterBtn" class="btn small" onclick="calculateAndRender()">Filtrar</button>
                            <button id="resetFilterBtn" class="btn small secondary" onclick="resetFilters()">Limpar</button>
                        </div>
                    </div>
                    <div style="margin-top:8px;">
                        <label style="font-weight:600;color:var(--muted)">
                            <input type="checkbox" id="showIndividualOps" checked onchange="calculateAndRender()"> Mostrar Detalhe por Opera√ß√£o
                        </label>
                    </div>
                </div>
                <div class="totals">
                    <div class="total-card" id="totalCompromissadaDisplay"><h4>Compromissada TOTAL</h4><p>R$ 0,00</p></div>
                    <div class="total-card" id="totalRetornoDisplay"><h4>Retorno Bruto TOTAL</h4><p>R$ 0,00</p></div>
                    <div class="total-card" id="totalCdiDisplay"><h4>Ganho (R$) TOTAL</h4><p>R$ 0,00</p></div>
                </div>
                <div class="table-wrap">
                    <div id="resultTable"></div>
                </div>
                <p style="font-size:12px;color:var(--muted);margin-top:10px;">
                    ‚ö†Ô∏è O <strong>Ganho (R$) Di√°rio</strong> √© calculado pelo Valor Retorno Bruto - Valor Compromissada, com invers√£o para RECOMPRA.
                </p>
            </div>
            
            <div id="input-panel" class="card">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <h3 style="margin:0 0 8px 0;">‚≠ê Configura√ß√£o Global</h3>
                </div>
                <div class="input-row">
                    <div>
                        <label for="taxaCdiAnual">Taxa CDI Anual Global (%)</label>
                        <input type="text" id="taxaCdiAnual" placeholder="14,90" value="14,90" onchange="saveState()">
                    </div>
                    <div>
                        <label for="diasAno">Dias no Ano</label>
                        <input type="text" id="diasAno" placeholder="252" value="252" onchange="saveState()">
                    </div>
                </div>
                <hr style="border:none;border-top:1px solid rgba(15,23,36,0.04);margin:12px 0;">
                <div>
                    <h3 style="margin:0 0 8px 0;">üìÇ Importa√ß√£o</h3>
                    <p style="font-size:12px;color:var(--muted);margin:0 0 10px 0;">
                        *O sistema tenta reconhecer os cabe√ßalhos, priorizando 'TX. 252' para a taxa CDI.
                    </p>
                </div>
                <hr style="border:none;border-top:1px solid rgba(15,23,36,0.04);margin:12px 0;">
                <div>
                    <h3 style="margin:0 0 8px 0;">‚ûï Lan√ßamento Manual</h3>
                    <div style="display:flex;flex-direction:column;gap:8px;">
                        <input type="hidden" id="editIndex" value="-1">
                        <div><label for="manualData">Data do Lan√ßamento</label><br><input type="date" id="manualData" required></div>
                        <div><label for="manualDesc">Descri√ß√£o</label><br><input type="text" id="manualDesc" placeholder="Ex: REVENDA - Aplica√ß√£o M√™s"></div>
                        <div><label for="manualBanco">Banco / Contraparte</label><br><input type="text" id="manualBanco" placeholder="Ex: BTG Pactual"></div>
                        <div style="display:flex;gap:8px;">
                            <div style="flex:1;"><label for="manualCedente">Conta Cedente</label><br><input type="text" id="manualCedente" placeholder="8300005"></div>
                            <div style="flex:1;"><label for="manualCessionario">Conta Cession√°rio</label><br><input type="text" id="manualCessionario" placeholder="12000005"></div>
                        </div>
                        <div><label for="manualCdiTaxa">Taxa CDI Anual Espec√≠fica (%)</label><br><input type="text" id="manualCdiTaxa" placeholder="14,90 (Deixar vazio para usar Global)"></div>
                        <div style="display:flex;gap:8px;">
                            <div style="flex:1;"><label for="manualCompromissada">Valor Compromissada</label><br><input type="text" id="manualCompromissada" placeholder="10.000,00"></div>
                            <div style="flex:1;"><label for="manualRetorno">Valor Retorno (Bruto)</label><br><input type="text" id="manualRetorno" placeholder="10.050,25"></div>
                        </div>
                        <div style="display:flex;gap:8px;">
                            <button id="addBtn" class="btn" style="flex:1;" onclick="addOperation()">Adicionar Lan√ßamento</button>
                            <button id="cancelEditBtn" class="btn secondary" style="flex:1;display:none;" onclick="cancelEdit()">Cancelar Edi√ß√£o</button>
                        </div>
                    </div>
                </div>
                <pre id="log" style="height:84px;overflow:auto;margin-top:12px;color:var(--muted);">Aguardando...</pre>
            </div>
        </div>
    </div>
    
    <script>
        /* =============================================   Configura√ß√µes Firebase   ============================================= */
        const firebaseConfig = {
            apiKey: "AIzaSyD_vxw2VcSPO_tMXgrl7quZ85ODvpqQuR8",
            authDomain: "controle-cdi.firebaseapp.com",
            projectId: "controle-cdi",
            storageBucket: "controle-cdi.firebasestorage.app",
            messagingSenderId: "215359645646",
            appId: "1:215359645646:web:d18dae706d90823622ad9f",
            measurementId: "G-GD0S6YH5LJ"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(app);
        const auth = firebase.auth(); 
        const globalDocRef = db.collection('cdi_ganhos').doc('estado_global');

        /* Vari√°veis Globais de Estado */
        let operacoes = []; 
        let totalCompromissada=0, totalRetorno=0, totalGanho=0;
        let fileToImport = null; // Vari√°vel para armazenar o arquivo selecionado
        
        /* -------------------------   Fun√ß√µes Firebase AUTH   ------------------------- */

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                alert('Preencha email e senha.');
                return;
            }

            try {
                document.getElementById('loadingOverlay').style.display = 'flex';
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                document.getElementById('loadingOverlay').style.display = 'none';
                alert(`Erro de Login: Verifique suas credenciais. (${error.message})`);
            }
        }

        function handleLogout() {
            if (confirm('Deseja sair do sistema?')) {
                auth.signOut();
            }
        }

        function checkAuthState() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    document.getElementById('loginModal').style.display = 'none';
                    document.getElementById('appContent').style.display = 'block';
                    document.getElementById('loadingOverlay').style.display = 'flex';
                    setupFirestoreListener(); 
                } else {
                    document.getElementById('appContent').style.display = 'none';
                    document.getElementById('loginModal').style.display = 'flex';
                    document.getElementById('loadingOverlay').style.display = 'none';
                }
            });
        }
        
        /* -------------------------   Firestore Listener para o Estado Global   ------------------------- */

        function setupFirestoreListener(){
            globalDocRef.onSnapshot(doc => {
                document.getElementById('loadingOverlay').style.display = 'none';

                if (doc.exists) {
                    const data = doc.data();
                    operacoes = data.operacoes || [];
                    document.getElementById('taxaCdiAnual').value = data.taxaCdiAnual || '14,90';
                    document.getElementById('diasAno').value = data.diasAno || '252';
                    log(`üíæ ${operacoes.length} opera√ß√µes carregadas da Nuvem.`);
                } else {
                    operacoes = [];
                    log('Aguardando... Documento de dados n√£o encontrado. Inicialize com Importa√ß√£o.');
                }
                calculateAndRender();
            }, err => {
                console.error('Erro Firestore', err);
                document.getElementById('loadingOverlay').style.display = 'none'; 
                alert('Erro ao carregar dados do Firebase. Verifique suas Regras de Seguran√ßa.');
            });
        }
        
        /* -------------------------   Persist√™ncia Firestore (Substitui localStorage)   ------------------------- */

        function saveState(){ 
            // Somente usu√°rios logados podem salvar (controlado pelo auth)
            if (!auth.currentUser) {
                log('ERRO: Voc√™ precisa estar logado para salvar dados na Nuvem.');
                return;
            }

            const stateToSave = {
                operacoes: operacoes,
                taxaCdiAnual: document.getElementById('taxaCdiAnual').value,
                diasAno: document.getElementById('diasAno').value,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            globalDocRef.set(stateToSave)
                .then(() => {
                    // O log e renderiza√ß√£o s√£o feitos pelo Listener
                })
                .catch(e => {
                    console.error('Erro ao salvar:', e);
                    log('‚ùå Erro ao salvar dados na Nuvem.');
                });
        }

        window.loadState = ()=>{
            resetThemeToFixed(); 
            try {
                // Manter o logo salvo localmente
                const savedLogo = localStorage.getItem('cdiLogo');
                if (savedLogo) {
                    siteLogo.src = savedLogo;
                    siteLogo.style.display = 'block';
                    log('üíæ Logo carregado do salvamento local.');
                }
            } catch (err) { console.warn(err); }
            attachFilterListeners(); 
            // PONTO DE PARTIDA: CHAMA A VERIFICA√á√ÉO DE LOGIN
            checkAuthState(); 
        };

        /* ---------- Fun√ß√µes utilit√°rias e l√≥gica ---------- */

        function log(message) { document.getElementById('log').textContent = message; }
        
        function resetThemeToFixed() {
            document.documentElement.style.setProperty('--primary', '#0A0A33');
            document.documentElement.style.setProperty('--primary-light', '#1A1A55');
            document.documentElement.style.setProperty('--secondary', '#C00000');
            document.documentElement.style.setProperty('--secondary-light', '#E00000');
            
            document.querySelectorAll('.btn:not(.secondary):not(.danger)').forEach(b => {
                b.style.background = 'var(--primary)'; b.style.border = '1px solid white'; b.style.color = 'white';
            });
            document.querySelectorAll('.btn.secondary').forEach(b => {
                b.style.background = 'var(--secondary)'; b.style.border = '1px solid white'; b.style.color = 'white';
            });
            document.querySelectorAll('.btn.danger').forEach(b=>{
                b.style.background = getComputedStyle(document.documentElement).getPropertyValue('--secondary').trim();
                b.style.color = '#ffffff'; b.style.border = '1px solid white';
            });
        }
        
        const siteLogo = document.getElementById('siteLogo');
        const logoInput = document.getElementById('logoFile');
        
        async function compressImageFile(file, quality = 0.7, maxSize = 600) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ratio = Math.min(1, maxSize / Math.max(img.width, img.height));
                        canvas.width = Math.round(img.width * ratio);
                        canvas.height = Math.round(img.height * ratio);
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        try {
                            const dataUrl = canvas.toDataURL('image/jpeg', quality);
                            resolve(dataUrl);
                        } catch (err) { reject(err); }
                    };
                    img.onerror = reject;
                    img.src = reader.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        if (logoInput) {
            logoInput.addEventListener('change', async (e) => {
                const file = e.target.files && e.target.files[0];
                if(!file) return;
                try {
                    const compressed = await compressImageFile(file, 0.7, 600);
                    siteLogo.src = compressed;
                    siteLogo.style.display = 'block';
                    localStorage.setItem('cdiLogo', compressed); 
                    log('‚úÖ Logo salvo localmente.');
                } catch (err) {
                    console.error(err);
                    log('‚ùå Erro ao processar o logo.');
                }
                resetThemeToFixed();
            });
        }
        
        function removeLogo() {
            if(!confirm('Tem certeza que deseja remover logo salvo e restaurar padr√£o?')) return;
            localStorage.removeItem('cdiLogo');
            siteLogo.src = '';
            siteLogo.style.display = 'none';
            resetThemeToFixed();
            log('üóëÔ∏è Logo removido. Tema restaurado.');
        }

        // --- Fun√ß√µes de processamento de dados ---
        function cleanCurrency(v){ 
            if(typeof v!=='string') v=String(v); 
            let cleanString = v.replace(/[R$\s]/g, '');
            cleanString = cleanString.replace(/\./g, '');
            cleanString = cleanString.replace(/,/g, '.');
            const n=parseFloat(cleanString); 
            return isNaN(n)?0:n; 
        }
        function parseNumber(v){ 
            if(v===undefined||v===null||v==='') return 0; 
            if(typeof v==='string' && (v.includes(',') || v.includes('R$'))) return cleanCurrency(v); 
            const n=parseFloat(v); 
            return isNaN(n)?0:n; 
        }
        function cleanCdiTaxa(v){ 
            if(v===undefined||v===null||v==='') return 0; 
            if(typeof v!=='string') v=String(v); 
            v=v.replace(/[^0-9,.]/g,''); 
            let c=v.replace(',','.'); 
            const parts=c.split('.'); 
            if(parts.length>2) c=parts.slice(0,-1).join('')+'.'+parts.slice(-1); 
            const n=parseFloat(c); 
            return isNaN(n)?0:n; 
        }
        function formatBRL(n){ return n.toLocaleString('pt-BR',{style:'currency',currency:'BRL',minimumFractionDigits:2}); }
        function formatPercent(n){ if(n===undefined||n===null||isNaN(n)) return ''; return n.toFixed(4).replace('.',','); }
        function formatPU(n){ if(n===undefined||n===null||isNaN(n)||n===0) return '-'; return n.toLocaleString('pt-BR',{minimumFractionDigits:4,maximumFractionDigits:4}); }
        function formatDataBR(s){ if(!s) return '-'; if(s.match(/^\d{4}-\d{2}-\d{2}$/)){ const [y,m,d]=s.split('-'); return `${d}/${m}/${y}`; } if(s.match(/^\d{2}\/\d{2}\/\d{4}$/)) return s; const d=new Date(s); if(!isNaN(d)) return d.toLocaleDateString('pt-BR'); return s; }
        function normalizeDate(s){ 
            if(!s) return ''; 
            s=String(s).trim(); 
            if(s.match(/^\d{4}-\d{2}-\d{2}$/)) return s; 
            if(s.match(/^\d{2}\/\d{2}\/\d{4}$/)){
                const [d,m,y]=s.split('/');
                return `${y}-${m}-${d}`;
            }
            const num=parseFloat(s);
            if(!isNaN(num) && num>25569 && num<70000){ // Excel serial date
                const base=new Date('1899-12-30'); 
                const date=new Date(base.getTime() + num*24*60*60*1000); 
                if(!isNaN(date)){
                    const y=date.getUTCFullYear();
                    const m=date.getUTCMonth()+1;
                    const d=date.getUTCDate();
                    const pad=n=>n<10?'0'+n:n;
                    return `${y}-${pad(m)}-${pad(d)}`;
                }
            }
            try{ const d=new Date(s); if(!isNaN(d)) return d.toISOString().split('T')[0]; }catch(e){}
            return ''; 
        }

        /* Renderiza√ß√£o */
        function updateTotalCards(){ 
            document.querySelector('#totalCompromissadaDisplay p').textContent = formatBRL(totalCompromissada); 
            document.querySelector('#totalRetornoDisplay p').textContent = formatBRL(totalRetorno); 
            document.querySelector('#totalCdiDisplay p').textContent = formatBRL(totalGanho); 
        }
        
        function calculateAndRender(){
            totalCompromissada=0; totalRetorno=0; totalGanho=0;
            const cdiGlobal = cleanCdiTaxa(document.getElementById('taxaCdiAnual').value);
            const diasAno = parseNumber(document.getElementById('diasAno').value) || 252;
            const showIndividual = document.getElementById('showIndividualOps').checked;
            
            const filterStartDateStr = document.getElementById('filterStartDate').value;
            const filterEndDateStr = document.getElementById('filterEndDate').value;
            const filterStart = filterStartDateStr ? normalizeDate(filterStartDateStr) : '';
            const filterEnd = filterEndDateStr ? normalizeDate(filterEndDateStr) : '';

            let ops = operacoes.filter(op=>{
                const d = normalizeDate(op.data);
                if(!d) return false;
                if(filterStart && d < filterStart) return false;
                if(filterEnd && d > filterEnd) return false;
                return true;
            });
            ops.sort((a,b)=> normalizeDate(a.data).localeCompare(normalizeDate(b.data)));
            
            document.getElementById('taxaCdiAnual').value = formatPercent(cdiGlobal);
            document.getElementById('diasAno').value = diasAno;
            
            let html = "<table><thead><tr><th>Data</th><th>Descri√ß√£o/Resumo</th><th>Banco</th><th>Conta Cedente</th><th>Conta Cession√°rio</th><th>Compromissada</th><th>Retorno Bruto</th><th>PU IDA</th><th>PU VOLTA</th><th>Taxa CDI Anual (%)</th><th>Ganho (R$) Di√°rio</th><th class='action-cell'>A√ß√µes</th></tr></thead><tbody>";
            const resumo = {};
            
            ops.forEach(op=>{
                const d = normalizeDate(op.data);
                const comp = parseNumber(op.compromissada); 
                const ret = parseNumber(op.retorno);
                const ganho = (ret - comp) * ( (typeof op.descricao === 'string' && op.descricao.toUpperCase().includes('RECOMPRA')) ? -1 : 1 );
                const taxaUsada = (cleanCdiTaxa(op.cdiTaxa) > 0 && cleanCdiTaxa(op.cdiTaxa) !== 100) ? cleanCdiTaxa(op.cdiTaxa) : cdiGlobal;
                
                totalCompromissada += comp; totalRetorno += ret; totalGanho += ganho;
                
                if(!resumo[d]) resumo[d] = { data:d, totalCompromissada:0, totalRetorno:0, totalGanho:0, primeiraTaxa: taxaUsada };
                resumo[d].totalCompromissada += comp; resumo[d].totalRetorno += ret; resumo[d].totalGanho += ganho;
                
                if(showIndividual){
                    const ganhoClass = ganho>0 ? 'ganho' : (ganho<0 ? 'perda' : ''); 
                    html += `<tr class="individual-operation-row">
                        <td class="col-data">${formatDataBR(op.data)}</td>
                        <td class="col-left">${(op.descricao||'-')}</td>
                        <td class="col-left">${(op.banco||'-')}</td>
                        <td>${op.contaCedente||'-'}</td>
                        <td>${op.contaCessionario||'-'}</td>
                        <td>${formatBRL(comp)}</td>
                        <td>${formatBRL(ret)}</td>
                        <td>${formatPU(parseNumber(op.puIda))}</td>
                        <td>${formatPU(parseNumber(op.puVolta))}</td>
                        <td style="text-align:center;">${(Number(taxaUsada)||0).toFixed(4).replace('.',',')}</td>
                        <td class="${ganhoClass}">${formatBRL(ganho)}</td>
                        <td class="action-cell">
                            <button class="btn small" onclick="editOperation(${operacoes.indexOf(op)})">Alterar</button>
                            <button class="btn small secondary" onclick="deleteOperation(${operacoes.indexOf(op)})">Excluir</button>
                        </td>
                    </tr>`;
                }
            });
            
            const datas = Object.keys(resumo).sort();
            if(showIndividual && datas.length) html += `<tr><td colspan="12" style="text-align:left;background:rgba(0,0,0,0.02);font-weight:700;">RESUMO DI√ÅRIO (Consolida√ß√£o por dia)</td></tr>`;
            
            datas.forEach(k=>{
                const r = resumo[k];
                const ganhoClass = r.totalGanho>0 ? 'ganho' : (r.totalGanho<0 ? 'perda' : ''); 
                const taxaExib = (cleanCdiTaxa(r.primeiraTaxa) > 0 ? r.primeiraTaxa : cleanCdiTaxa(document.getElementById('taxaCdiAnual').value));
                html += `<tr class="daily-summary-row">
                    <td class="col-data">${formatDataBR(r.data)}</td>
                    <td class="col-left">Soma Di√°ria</td>
                    <td class="col-left">-</td><td>-</td><td>-</td>
                    <td>${formatBRL(r.totalCompromissada)}</td>
                    <td>${formatBRL(r.totalRetorno)}</td>
                    <td>-</td><td>-</td><td style="text-align:center;">${(Number(taxaExib)||0).toFixed(4).replace('.',',')}</td>
                    <td class="${ganhoClass}">${formatBRL(r.totalGanho)}</td>
                    <td class="action-cell">-</td>
                </tr>`;
            });
            
            html += "</tbody></table>";
            document.getElementById('resultTable').innerHTML = html;
            updateTotalCards();
        }
        
        function attachFilterListeners(){
            document.getElementById('filterBtn').addEventListener('click', calculateAndRender);
            document.getElementById('resetFilterBtn').addEventListener('click', resetFilters);
        }

        function resetFilters(){
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            calculateAndRender();
        }

        // ------------------------- Importa√ß√£o (Nova L√≥gica com Confirma√ß√£o) -------------------------
        
        function selectFile(event) {
            const files = event.target.files;
            const fileNameDisplay = document.getElementById('fileNameDisplay');
            const importBtn = document.getElementById('importBtn');

            if (files.length === 0) {
                fileToImport = null;
                fileNameDisplay.textContent = 'Nenhum arquivo selecionado.';
                fileNameDisplay.style.display = 'none';
                importBtn.disabled = true;
                log('Nenhum arquivo selecionado.');
                return;
            }
            
            // Armazena o arquivo e exibe o nome
            fileToImport = files[0];
            fileNameDisplay.textContent = fileToImport.name;
            fileNameDisplay.style.display = 'inline-block';
            importBtn.disabled = false;
            log(`Arquivo selecionado: ${fileToImport.name}. Clique em Importar para processar.`);
        }

        function importSelectedFile() {
            if (!fileToImport) {
                log('Nenhum arquivo para importar.');
                return;
            }
            
            document.getElementById('loadingOverlay').style.display = 'flex';
            const fileName = fileToImport.name.toUpperCase();
            
            const callbackFinal = (novosDados) => {
                document.getElementById('loadingOverlay').style.display = 'none';
                
                if (novosDados.length > 0) {
                    operacoes = operacoes.concat(novosDados);
                    saveState(); 
                    log(`‚úÖ Importa√ß√£o de ${fileToImport.name} conclu√≠da. ${novosDados.length} novas opera√ß√µes adicionadas.`);
                } else {
                    log(`‚ùå Nenhuma opera√ß√£o v√°lida encontrada no arquivo ${fileToImport.name}. Verifique o cabe√ßalho.`);
                }
                
                // Limpa o estado da importa√ß√£o ap√≥s o processamento
                document.getElementById('excelFile').value = null; 
                document.getElementById('fileNameDisplay').textContent = 'Nenhum arquivo.';
                document.getElementById('fileNameDisplay').style.display = 'none';
                document.getElementById('importBtn').disabled = true;
                fileToImport = null;
            };
            
            if (fileName.endsWith('.XLSX') || fileName.endsWith('.XLS')) {
                readExcelFile(fileToImport, callbackFinal);
            } else if (fileName.endsWith('.CSV') || fileName.endsWith('.TXT')) {
                readCSVFile(fileToImport, callbackFinal);
            } else {
                document.getElementById('loadingOverlay').style.display = 'none';
                log(`Arquivo ${fileToImport.name} ignorado. Formato n√£o suportado.`);
                callbackFinal([]);
            }
        }


        function readExcelFile(file, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true, raw: false });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false, defval: null });
                    const operations = parseDataFromSheet(json);
                    callback(operations);
                } catch (error) {
                    console.error('Erro ao ler Excel:', error);
                    log(`‚ùå Erro ao processar o arquivo Excel. Verifique o formato das colunas.`);
                    callback([]);
                }
            };
            reader.onerror = function(e) {
                console.error('Erro de leitura do arquivo:', e);
                callback([]);
            };
            reader.readAsArrayBuffer(file);
        }

        function readCSVFile(file, callback) {
            Papa.parse(file, {
                header: false,
                skipEmptyLines: true,
                dynamicTyping: false,
                complete: function(results) {
                    const operations = parseDataFromSheet(results.data);
                    callback(operations);
                },
                error: function(error) {
                    console.error('Erro ao ler CSV:', error);
                    log(`‚ùå Erro ao processar o arquivo CSV.`);
                    callback([]);
                }
            });
        }
        
        function parseDataFromSheet(data) {
            if (!data || data.length < 2) return [];
            
            const headerRow = data[0].map(h => String(h || '').toUpperCase().replace(/[^A-Z0-9\.]/g, ' ').trim().replace(/\s+/g, '_'));
            const map = {};
            
            // Mapeamento de colunas (priorizando a identifica√ß√£o mais robusta)
            headerRow.forEach((h, i) => {
                if (h.includes('DATA')) map.data = i;
                else if (h.includes('DESCRICAO') || h.includes('RESUMO') || h.includes('OBSERVACAO')) map.desc = i;
                else if (h.includes('BANCO') || h.includes('CONTRAPARTE')) map.banco = i;
                else if (h.includes('CEDENTE')) map.cedente = i;
                else if (h.includes('CESSIONARIO')) map.cessionario = i;
                else if (h.includes('TX_252')) map.cdiTaxa = i; // Prefer√™ncia por 'TX. 252'
                else if (h.includes('COMPROMISSADA') || h.includes('VL_COMPROMISSADA')) map.compromissada = i;
                else if (h.includes('RETORNO') || h.includes('VL_RETORNO')) map.retorno = i;
                else if (h.includes('PU_IDA')) map.puIda = i;
                else if (h.includes('PU_VOLTA')) map.puVolta = i;
            });

            const operations = [];
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (!row[map.data] && !row[map.compromissada]) continue;
                
                const dataStr = normalizeDate(row[map.data]);
                if (!dataStr) continue;

                operations.push({
                    data: dataStr,
                    descricao: String(row[map.desc] || '').trim(),
                    banco: String(row[map.banco] || '').trim(),
                    contaCedente: String(row[map.cedente] || '').trim(),
                    contaCessionario: String(row[map.cessionario] || '').trim(),
                    cdiTaxa: cleanCdiTaxa(row[map.cdiTaxa] || 0),
                    compromissada: cleanCurrency(row[map.compromissada] || 0),
                    retorno: cleanCurrency(row[map.retorno] || 0),
                    puIda: parseNumber(row[map.puIda] || 0),
                    puVolta: parseNumber(row[map.puVolta] || 0),
                });
            }
            return operations;
        }

        // ------------------------- Lan√ßamento Manual -------------------------

        function addOperation() {
            const index = parseInt(document.getElementById('editIndex').value);
            const dataInput = document.getElementById('manualData').value;
            
            if (!dataInput) {
                alert('A data do lan√ßamento √© obrigat√≥ria.');
                return;
            }

            const newOp = {
                data: normalizeDate(dataInput),
                descricao: document.getElementById('manualDesc').value.trim(),
                banco: document.getElementById('manualBanco').value.trim(),
                contaCedente: document.getElementById('manualCedente').value.trim(),
                contaCessionario: document.getElementById('manualCessionario').value.trim(),
                cdiTaxa: cleanCdiTaxa(document.getElementById('manualCdiTaxa').value),
                compromissada: cleanCurrency(document.getElementById('manualCompromissada').value),
                retorno: cleanCurrency(document.getElementById('manualRetorno').value),
                // PU n√£o √© inserido manualmente neste formul√°rio, mas √© mantido
                puIda: 0,
                puVolta: 0
            };
            
            if (index > -1) {
                operacoes[index] = newOp;
                log(`‚úÖ Opera√ß√£o editada com sucesso.`);
            } else {
                operacoes.push(newOp);
                log(`‚úÖ Opera√ß√£o adicionada com sucesso.`);
            }

            document.getElementById('editIndex').value = '-1';
            document.getElementById('addBtn').textContent = 'Adicionar Lan√ßamento';
            document.getElementById('cancelEditBtn').style.display = 'none';

            // Limpa formul√°rio
            document.getElementById('manualData').value = '';
            document.getElementById('manualDesc').value = '';
            document.getElementById('manualBanco').value = '';
            document.getElementById('manualCedente').value = '';
            document.getElementById('manualCessionario').value = '';
            document.getElementById('manualCdiTaxa').value = '';
            document.getElementById('manualCompromissada').value = '';
            document.getElementById('manualRetorno').value = '';

            // AQUI SALVAMOS NA NUVEM!
            saveState(); 
        }

        function editOperation(index) {
            const op = operacoes[index];
            document.getElementById('manualData').value = op.data; 
            document.getElementById('manualDesc').value = op.descricao;
            document.getElementById('manualBanco').value = op.banco;
            document.getElementById('manualCedente').value = op.contaCedente;
            document.getElementById('manualCessionario').value = op.contaCessionario;
            document.getElementById('manualCdiTaxa').value = formatPercent(op.cdiTaxa);
            document.getElementById('manualCompromissada').value = op.compromissada.toFixed(2).replace('.', ',');
            document.getElementById('manualRetorno').value = op.retorno.toFixed(2).replace('.', ',');
            
            document.getElementById('editIndex').value = index;
            document.getElementById('addBtn').textContent = 'Salvar Altera√ß√£o';
            document.getElementById('cancelEditBtn').style.display = 'inline-flex';
            document.getElementById('input-panel').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEdit() {
            document.getElementById('editIndex').value = '-1';
            document.getElementById('addBtn').textContent = 'Adicionar Lan√ßamento';
            document.getElementById('cancelEditBtn').style.display = 'none';
            // Limpa formul√°rio
            document.getElementById('manualData').value = '';
            document.getElementById('manualDesc').value = '';
            document.getElementById('manualBanco').value = '';
            document.getElementById('manualCedente').value = '';
            document.getElementById('manualCessionario').value = '';
            document.getElementById('manualCdiTaxa').value = '';
            document.getElementById('manualCompromissada').value = '';
            document.getElementById('manualRetorno').value = '';
        }

        function deleteOperation(index) {
            if (confirm('Tem certeza que deseja excluir esta opera√ß√£o?')) {
                operacoes.splice(index, 1);
                log('üóëÔ∏è Opera√ß√£o exclu√≠da. Salvando na nuvem...');
                // AQUI SALVAMOS NA NUVEM!
                saveState(); 
            }
        }

        // ------------------------- A√ß√µes Globais -------------------------

        async function deleteAllData() {
            if (!confirm('ATEN√á√ÉO: Deseja apagar TODOS os dados de opera√ß√µes na Nuvem? Esta a√ß√£o √© IRREVERS√çVEL.')) return;
            
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            // Zerar array local
            operacoes = [];
            
            try {
                // Tenta apagar o documento inteiro
                await globalDocRef.delete();
                log('üóëÔ∏è Todos os dados de opera√ß√µes foram apagados da Nuvem.');
                // O listener vai pegar a mudan√ßa, mas for√ßamos o estado inicial
                document.getElementById('taxaCdiAnual').value = '14,90';
                document.getElementById('diasAno').value = '252';
                calculateAndRender();
            } catch (e) {
                console.error(e);
                alert('Erro ao apagar dados na nuvem.');
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        function exportExcel() {
            const items = operacoes.map(it => ({
                'DATA': formatDataBR(it.data),
                'DESCRICAO': it.descricao || '',
                'BANCO': it.banco || '',
                'CONTA CEDENTE': it.contaCedente || '',
                'CONTA CESSIONARIO': it.contaCessionario || '',
                'VALOR COMPROMISSADA': parseFloat(it.compromissada || 0), 
                'VALOR RETORNO': parseFloat(it.retorno || 0), 
                'PU IDA': it.puIda,
                'PU VOLTA': it.puVolta,
                'TAXA CDI (%)': it.cdiTaxa,
            }));
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(items, {header: ['DATA','DESCRICAO','BANCO','CONTA CEDENTE','CONTA CESSIONARIO','VALOR COMPROMISSADA','VALOR RETORNO','PU IDA','PU VOLTA','TAXA CDI (%)']});
            XLSX.utils.book_append_sheet(wb, ws, 'Ganhos_CDI');
            XLSX.writeFile(wb, 'Ganhos_CDI_Export.xlsx');
        }

    </script>
</body>
</html>

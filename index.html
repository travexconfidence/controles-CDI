<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Comparador PDF ‚áÑ Excel ‚Äî Controle CDI</title>

<!-- libs -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
:root{
  --primary:#0A0A33; --primary-light:#1A1A55; --secondary:#C00000;
  --muted:#6b7280; --card-bg:#fff; --radius:10px; --gap:12px;
  --shadow:0 8px 20px rgba(16,24,40,0.06);
}
*{box-sizing:border-box}
body{font-family:Inter,Roboto,Arial,sans-serif;margin:16px;background:#f4f8fb;color:#0f1724}
.card{background:var(--card-bg);padding:12px;border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid rgba(0,0,0,0.06)}
#header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
#logo-placeholder{font-size:24px}
h1{font-size:18px;margin:0}
#top-actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:space-between;padding:10px}
.left-actions{display:flex;gap:8px;align-items:center}
.right-actions{display:flex;gap:8px;align-items:center}
.btn{background:var(--primary);color:#fff;padding:8px 12px;border-radius:8px;border:1px solid #fff;cursor:pointer;font-weight:600}
.btn.secondary{background:var(--secondary)}
.btn.small{padding:6px 10px;font-size:13px}
.input-inline{display:inline-flex;align-items:center;gap:8px}
#main{display:flex;gap:12px;margin-top:12px;flex-direction:column}
.filter-card{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
.input-row{display:flex;gap:8px;align-items:center}
.totals{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
.total-card{padding:10px;border-radius:8px;border:1px solid rgba(15,23,36,0.04);background:linear-gradient(180deg,#fff,#fbfdff);min-width:180px}
.total-card h4{margin:0;font-size:12px;color:var(--muted)}
.total-card p{margin:6px 0 0 0;font-size:18px;font-weight:800}
.table-wrap{overflow:auto;border-radius:8px;margin-top:8px}
table{width:100%;border-collapse:collapse}
thead th{position:sticky;top:0;background:linear-gradient(180deg,var(--primary-light),var(--primary));color:#fff;padding:8px;text-align:left;font-weight:700}
tbody td{padding:8px;border-bottom:1px solid rgba(0,0,0,0.04);text-align:right}
.col-left{text-align:left;max-width:260px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--primary);font-weight:600}
.action-cell{text-align:center}
.ganho{color:#2e7d32;font-weight:800}
.perda{color:#c62828;font-weight:800}
#log{height:120px;overflow:auto;background:#fbfdff;padding:8px;border-radius:6px;border:1px solid rgba(0,0,0,0.03);font-size:13px;color:var(--muted)}
@media(max-width:800px){ .totals{flex-direction:column} .right-actions{justify-content:flex-end} }
</style>
</head>
<body>

<!-- HEADER -->
<div id="header">
  <div id="logo-placeholder">üìà</div>
  <div>
    <h1>Controle de Ganhos CDI</h1>
    <div style="font-size:12px;color:var(--muted)">Comparador PDF ‚áÑ Excel ‚Äî Resultado e Concilia√ß√£o</div>
  </div>
</div>

<!-- TOP ACTIONS -->
<div id="top-actions" class="card">
  <div class="left-actions">
    <div style="font-weight:700">1Ô∏è‚É£ Carregar PDF ‚Ä¢ 2Ô∏è‚É£ Carregar Excel ‚Ä¢ 3Ô∏è‚É£ Comparar</div>
  </div>

  <div class="right-actions">
    <span id="currentUserDisplay" style="font-weight:600;color:var(--muted);margin-right:6px">Desconectado</span>
    <button id="loginBtn" class="btn small">Login</button>
    <button id="logoutBtn" class="btn small secondary" style="display:none">Sair</button>

    <label style="display:inline-block">
      <input id="excelFile" type="file" accept=".xlsx,.xls,.csv,.txt" style="display:none" />
      <span class="btn small" onclick="document.getElementById('excelFile').click()">Carregar Excel</span>
    </label>

    <button id="importBtn" class="btn small secondary" title="Importar Selecionado">Importar Selecionado</button>

    <button id="compareBtn" class="btn small" title="Comparar">Comparar PDF ‚áÑ Excel</button>

    <button id="exportBtn" class="btn small secondary" title="Exportar">Exportar</button>
  </div>
</div>

<!-- MAIN -->
<div id="main">
  <div class="card">
    <div style="font-weight:700;margin-bottom:6px">Observa√ß√£o</div>
    <div style="font-size:13px;color:var(--muted)">Selecione o Excel e clique em <strong>Importar Selecionado</strong>. Se estiver logado os dados v√£o pro Firestore; sen√£o, ficam no localStorage.</div>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:700">Resultado da Concilia√ß√£o</div>
      <div style="font-size:12px;color:var(--muted)">Filtros r√°pidos</div>
    </div>

    <div class="filter-card" style="margin-top:10px">
      <div class="input-row">
        <label>Data In√≠cio</label>
        <input id="filterStartDate" type="date" />
      </div>
      <div class="input-row">
        <label>Data Fim</label>
        <input id="filterEndDate" type="date" />
      </div>
      <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
        <label style="font-weight:600;color:var(--muted)"><input id="showIndividualOps" type="checkbox" checked> Mostrar Detalhe por Opera√ß√£o</label>
        <button id="filterBtn" class="btn small">Filtrar</button>
        <button id="resetFilterBtn" class="btn small secondary">Limpar</button>
      </div>
    </div>

    <div class="totals" style="margin-top:12px">
      <div class="total-card">
        <h4>Compromissada TOTAL</h4>
        <p id="totalCompromissada">R$ 0,00</p>
      </div>
      <div class="total-card">
        <h4>Retorno Bruto TOTAL</h4>
        <p id="totalRetorno">R$ 0,00</p>
      </div>
      <div class="total-card">
        <h4>Ganho (R$) TOTAL</h4>
        <p id="totalGanho">R$ 0,00</p>
      </div>
    </div>

    <div class="table-wrap" id="tableWrap" style="margin-top:12px">
      <div id="resultTable">Nenhuma opera√ß√£o carregada.</div>
    </div>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:700">Log</div>
      <div style="font-size:12px;color:var(--muted)">Mensagens de processamento</div>
    </div>
    <pre id="log">Aguardando...</pre>
  </div>
</div>

<script>
/* ===================== CONFIG FIREBASE (usei o que voc√™ forneceu) ===================== */
const firebaseConfig = {
  apiKey: "AIzaSyD_vxw2VcSPO_tMXgrl7quZ85ODvpqQuR8",
  authDomain: "controle-cdi.firebaseapp.com",
  databaseURL: "https://controle-cdi-default-rtdb.firebaseio.com",
  projectId: "controle-cdi",
  storageBucket: "controle-cdi.firebasestorage.app",
  messagingSenderId: "215359645646",
  appId: "1:215359645646:web:cd61ae2f72e100d522ad9f"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
let globalDocRef = null;

/* ---------------- util ---------------- */
function log(msg){
  const el = document.getElementById('log');
  const now = new Date().toLocaleString('pt-BR');
  el.textContent = `${now} ‚Äî ${msg}\n` + el.textContent;
}
function formatBRL(n){ try { return n.toLocaleString('pt-BR',{style:'currency',currency:'BRL',minimumFractionDigits:2}); } catch(e){ return 'R$ 0,00'; } }
function cleanCurrency(v){
  if(v===undefined||v===null) return 0;
  if(typeof v !== 'string') v = String(v);
  let s = v.replace(/[R$\s]/g,'').trim();
  if(s.indexOf(',')>-1 && s.indexOf('.')>-1){
    // assume last comma is decimals
    const lastComma = s.lastIndexOf(',');
    const lastDot = s.lastIndexOf('.');
    if(lastComma > lastDot){
      s = s.replace(/\./g,'').replace(/,/g,'.');
    } else {
      s = s.replace(/,/g,'');
    }
  } else {
    s = s.replace(/\./g,'').replace(/,/g,'.');
  }
  const n = parseFloat(s);
  return isNaN(n)?0:n;
}
function parseNumber(v){
  if(v===undefined||v===null||v==='') return 0;
  if(typeof v === 'string' && (v.includes(',') || v.includes('R$') || v.includes('.'))) return cleanCurrency(v);
  const n = parseFloat(v);
  return isNaN(n)?0:n;
}
function normalizeDate(s){
  if(!s) return '';
  s = String(s).trim();
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  if(/^\d{2}\/\d{2}\/\d{4}$/.test(s)){ const [d,m,y]=s.split('/'); return `${y}-${m}-${d}`; }
  const num = parseFloat(s);
  if(!isNaN(num) && num>25569 && num<70000){
    const base = new Date('1899-12-30');
    const date = new Date(base.getTime() + num*24*60*60*1000);
    if(!isNaN(date)){
      const y = date.getUTCFullYear(); const m = date.getUTCMonth()+1; const d = date.getUTCDate();
      const pad = n=> n<10? '0'+n: n;
      return `${y}-${pad(m)}-${pad(d)}`;
    }
  }
  const d = new Date(s);
  if(!isNaN(d)) return d.toISOString().split('T')[0];
  return '';
}

/* ---------------- state ---------------- */
let operacoes = [];
let fileToImport = null;

/* --------- UI bindings --------- */
document.getElementById('excelFile').addEventListener('change', (e)=>{
  const files = e.target.files;
  if(!files || files.length===0){ fileToImport = null; log('Nenhum arquivo selecionado.'); return; }
  fileToImport = files[0];
  log(`Arquivos prontos: ${fileToImport.name}`);
});
document.getElementById('importBtn').addEventListener('click', importSelectedFile);
document.getElementById('filterBtn').addEventListener('click', calculateAndRender);
document.getElementById('resetFilterBtn').addEventListener('click', ()=>{
  document.getElementById('filterStartDate').value=''; document.getElementById('filterEndDate').value=''; calculateAndRender();
});
document.getElementById('exportBtn').addEventListener('click', exportToExcel);
document.getElementById('loginBtn').addEventListener('click', loginUser);
document.getElementById('logoutBtn').addEventListener('click', logoutUser);
document.getElementById('compareBtn').addEventListener('click', ()=>{ log('Compara√ß√£o acionada (a l√≥gica de compara√ß√£o de PDF n√£o est√° implementada aqui).') });

/* ---------------- Firebase Auth ---------------- */
function loginUser(){
  const email = prompt('Digite seu e-mail:');
  const pass = prompt('Digite sua senha:');
  if(!email||!pass){ log('Login cancelado.'); return; }
  log('Tentando login...');
  firebase.auth().signInWithEmailAndPassword(email, pass)
    .then(()=> log(`Login bem-sucedido: ${email}`))
    .catch(err=>{
      if(err.code==='auth/user-not-found'){
        log('Usu√°rio n√£o encontrado. Criando conta...');
        firebase.auth().createUserWithEmailAndPassword(email, pass)
          .then(()=> log(`Conta criada e logada: ${email}`))
          .catch(e=> log('‚ùå Erro: '+e.message));
      } else log('‚ùå Erro: '+err.message);
    });
}

function logoutUser(){
  firebase.auth().signOut().then(()=> log('Logout realizado.')).catch(e=> log('Erro ao sair: '+e.message));
}

firebase.auth().onAuthStateChanged(user=>{
  if(user){
    document.getElementById('currentUserDisplay').textContent = user.email;
    document.getElementById('loginBtn').style.display='none';
    document.getElementById('logoutBtn').style.display='inline-block';
    globalDocRef = db.collection('users').doc(user.uid);
    // load remote state if exists
    globalDocRef.get().then(doc=>{
      if(doc.exists){
        const st = doc.data();
        operacoes = st.operacoes || [];
        log(`üîÅ ${operacoes.length} opera√ß√µes carregadas do Firestore.`);
        calculateAndRender();
      } else {
        log('üîÅ 0 opera√ß√µes carregadas do Firestore.');
      }
    }).catch(e=> log('Erro ao ler Firestore: '+e.message));
  } else {
    document.getElementById('currentUserDisplay').textContent = 'Desconectado';
    document.getElementById('loginBtn').style.display='inline-block';
    document.getElementById('logoutBtn').style.display='none';
    globalDocRef = null;
    // load local
    try{
      const s = localStorage.getItem('cdiControlState');
      if(s){
        const st = JSON.parse(s);
        operacoes = st.operacoes || [];
        log('Dados locais carregados.');
        calculateAndRender();
      } else {
        log('Aguardando... (sem dados locais)');
      }
    }catch(e){ log('Erro ao carregar local: '+e.message) }
  }
});

/* ---------------- Import / Read ---------------- */
function importSelectedFile(){
  if(!fileToImport){ log('Nenhum arquivo para importar.'); return; }
  const name = fileToImport.name.toUpperCase();
  log('Iniciando importa√ß√£o: ' + fileToImport.name);
  const cb = (novos)=>{
    fileToImport = null; document.getElementById('excelFile').value='';
    if(novos.length>0){
      operacoes = operacoes.concat(novos);
      log(`‚úÖ ${novos.length} novas opera√ß√µes importadas. Salvando...`);
      saveState();
      calculateAndRender();
    } else {
      log('‚ö†Ô∏è Nenhuma opera√ß√£o v√°lida encontrada nos arquivos.');
    }
  };
  if(name.endsWith('.XLSX')||name.endsWith('.XLS')) readExcelFile(fileToImport, cb);
  else if(name.endsWith('.CSV')||name.endsWith('.TXT')) readCSVFile(fileToImport, cb);
  else { log('Formato n√£o suportado.'); cb([]); }
}

function readExcelFile(file, callback){
  const reader = new FileReader();
  reader.onload = (e)=>{
    try{
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type:'array', cellDates:true });
      const first = workbook.SheetNames[0];
      const ws = workbook.Sheets[first];
      const json = XLSX.utils.sheet_to_json(ws, { header:1, raw:false, dateNF:'yyyy-mm-dd' });
      if(!json || json.length<2){ callback([]); return; }
      const headers = json[0].map(h=>String(h||'').trim().toUpperCase());
      const rows = json.slice(1);
      const parsed = parseDataFromSheet(headers, rows);
      callback(parsed);
    }catch(err){
      console.error(err); log('‚ùå Erro ao processar Excel.');
      callback([]);
    }
  };
  reader.onerror = (err)=>{ log('‚ùå Erro leitura Excel: '+err); callback([]); };
  reader.readAsArrayBuffer(file);
}

function readCSVFile(file, callback){
  Papa.parse(file, {
    header:false, skipEmptyLines:true, encoding:'ISO-8859-1',
    complete: function(results){
      if(!results || !results.data || results.data.length<2){ callback([]); return; }
      const headers = results.data[0].map(h=>String(h||'').trim().toUpperCase());
      const rows = results.data.slice(1);
      const parsed = parseDataFromSheet(headers, rows);
      callback(parsed);
    },
    error: function(err){ log('‚ùå Erro CSV: '+err.message); callback([]); }
  });
}

function parseDataFromSheet(headers, dataRows){
  const map = {
    data:['DATA','DATA OPERA√á√ÉO','DATA OPERA√á√ÉO '],
    descricao:['DESCRI√á√ÉO','DESCRICAO','RESUMO','EVENTO'],
    banco:['BANCO','CONTRAPARTE'],
    contaCedente:['CONTA CEDENTE','CEDENTE'],
    contaCessionario:['CONTA CESSION√ÅRIO','CONTA CESSIONARIO','CESSIONARIO'],
    compromissada:['VALOR COMPROMISSADA','COMPROMISSADA','VALOR COMPROMISSADO','VALOR COMPROMISSADO'],
    retorno:['VALOR RETORNO BRUTO','RETORNO BRUTO','RETORNO'],
    cdiTaxa:['TX. CDI %','TX. 252','TAXA','TAXA CDI'],
    puIda:['PU IDA','PU INICIAL'],
    puVolta:['PU VOLTA','PU FINAL']
  };
  const columnIndex = {};
  Object.keys(map).forEach(k=>{
    const idx = headers.findIndex(h => map[k].includes(String(h||'').toUpperCase()));
    if(idx !== -1) columnIndex[k]=idx;
  });
  if(columnIndex.data===undefined || columnIndex.compromissada===undefined || columnIndex.retorno===undefined || columnIndex.descricao===undefined || columnIndex.banco===undefined){
    log('‚ö†Ô∏è Cabe√ßalhos essenciais n√£o detectados (Data / Compromissada / Retorno). Verifique seu arquivo.');
    return [];
  }

  const parsed = [];
  dataRows.forEach((row, i)=>{
    if(!row || row.length===0) return;
    if(row.every(c => c===undefined || c===null || String(c).trim()==='')) return;
    const op = {
      data: normalizeDate(row[columnIndex.data]),
      descricao: row[columnIndex.descricao] || '',
      banco: row[columnIndex.banco] || '',
      contaCedente: row[columnIndex.contaCedente] || '',
      contaCessionario: row[columnIndex.contaCessionario] || '',
      compromissada: parseNumber(row[columnIndex.compromissada]),
      retorno: parseNumber(row[columnIndex.retorno]),
      cdiTaxa: (columnIndex.cdiTaxa!==undefined? parseNumber(row[columnIndex.cdiTaxa]):0),
      puIda: (columnIndex.puIda!==undefined? parseNumber(row[columnIndex.puIda]):0),
      puVolta: (columnIndex.puVolta!==undefined? parseNumber(row[columnIndex.puVolta]):0),
      source: `Importa√ß√£o ${new Date().toISOString()}`
    };
    if(op.data && op.compromissada>0 && op.retorno>=0) parsed.push(op);
    else if(i<10) console.warn(`Linha ${i+2} ignorada ->`, row);
  });
  return parsed;
}

/* ---------------- Render / Save ---------------- */
function saveState(){
  // if logged, save to Firestore; else save to localStorage
  if(globalDocRef){
    const st = { operacoes, timestamp: firebase.firestore.FieldValue.serverTimestamp() };
    globalDocRef.set(st).then(()=> log('‚úÖ Dados salvos no Firestore.')).catch(e=> log('‚ùå Erro salvar Firestore: '+e.message));
  } else {
    try{
      const st = { operacoes, timestamp: new Date().toISOString() };
      localStorage.setItem('cdiControlState', JSON.stringify(st));
      log('‚úÖ Dados salvos localmente (usu√°rio n√£o logado).');
    }catch(e){ log('‚ùå Erro salvar localmente: '+e.message); }
  }
}

function calculateAndRender(){
  let totalComp=0, totalRet=0, totalGain=0;
  const showIndividual = document.getElementById('showIndividualOps').checked;
  const filterStart = document.getElementById('filterStartDate').value ? normalizeDate(document.getElementById('filterStartDate').value): '';
  const filterEnd = document.getElementById('filterEndDate').value ? normalizeDate(document.getElementById('filterEndDate').value): '';

  let ops = operacoes.filter(op=>{
    const d = normalizeDate(op.data);
    if(!d) return false;
    if(filterStart && d < filterStart) return false;
    if(filterEnd && d > filterEnd) return false;
    return true;
  });
  ops.sort((a,b)=> normalizeDate(a.data).localeCompare(normalizeDate(b.data)));

  let html = "<table><thead><tr><th>Data</th><th>Descri√ß√£o/Resumo</th><th>Banco</th><th>Conta Cedente</th><th>Conta Cession√°rio</th><th>Compromissada</th><th>Retorno Bruto</th><th>PU IDA</th><th>PU VOLTA</th><th>Taxa CDI Anual (%)</th><th>Ganho (R$) Di√°rio</th><th class='action-cell'>A√ß√µes</th></tr></thead><tbody>";
  const resumo = {};
  ops.forEach((op, idx)=>{
    const d = normalizeDate(op.data);
    const comp = parseNumber(op.compromissada);
    const ret = parseNumber(op.retorno);
    const ganho = ret - comp;
    totalComp += comp; totalRet += ret; totalGain += ganho;
    if(!resumo[d]) resumo[d]={data:d,totalCompromissada:0,totalRetorno:0,totalGanho:0};
    resumo[d].totalCompromissada += comp; resumo[d].totalRetorno += ret; resumo[d].totalGanho += ganho;
    if(showIndividual){
      const ganhoClass = ganho>0? 'ganho' : (ganho<0? 'perda' : '');
      html += `<tr>
        <td>${formatDateForDisplay(op.data)}</td>
        <td class="col-left">${(op.descricao||'-')}</td>
        <td class="col-left">${(op.banco||'-')}</td>
        <td>${op.contaCedente||'-'}</td>
        <td>${op.contaCessionario||'-'}</td>
        <td style="text-align:right">${formatBRL(comp)}</td>
        <td style="text-align:right">${formatBRL(ret)}</td>
        <td style="text-align:right">${op.puIda? op.puIda.toFixed(4): '-'}</td>
        <td style="text-align:right">${op.puVolta? op.puVolta.toFixed(4): '-'}</td>
        <td style="text-align:center">${op.cdiTaxa? parseFloat(op.cdiTaxa).toFixed(4).replace('.',',') : '-'}</td>
        <td class="${ganhoClass}">${formatBRL(ganho)}</td>
        <td class="action-cell">-</td>
      </tr>`;
    }
  });

  // daily summaries
  const dias = Object.keys(resumo).sort();
  if(showIndividual && dias.length) html += `<tr><td colspan="12" style="text-align:left;background:rgba(0,0,0,0.02);font-weight:700;">RESUMO DI√ÅRIO</td></tr>`;
  dias.forEach(k=>{
    const r = resumo[k];
    const ganhoClass = r.totalGanho>0? 'ganho' : (r.totalGanho<0? 'perda' : '');
    html += `<tr style="background:rgba(0,0,0,0.03)">
      <td>${formatDateForDisplay(r.data)}</td>
      <td class="col-left">Soma Di√°ria</td>
      <td class="col-left">-</td><td>-</td><td>-</td>
      <td style="text-align:right">${formatBRL(r.totalCompromissada)}</td>
      <td style="text-align:right">${formatBRL(r.totalRetorno)}</td>
      <td>-</td><td>-</td><td style="text-align:center">-</td>
      <td class="${ganhoClass}">${formatBRL(r.totalGanho)}</td>
      <td class="action-cell">-</td>
    </tr>`;
  });

  // totals row
  const totalClass = totalGain>0? 'ganho' : (totalGain<0? 'perda':'' );
  html += `<tr style="font-weight:700;background:rgba(0,0,0,0.02)"><td colspan="5">TOTAL GERAL</td><td style="text-align:right">${formatBRL(totalComp)}</td><td style="text-align:right">${formatBRL(totalRet)}</td><td>-</td><td>-</td><td>-</td><td class="${totalClass}" style="text-align:right">${formatBRL(totalGain)}</td><td></td></tr>`;

  html += "</tbody></table>";
  document.getElementById('resultTable').innerHTML = html;
  document.getElementById('totalCompromissada').textContent = formatBRL(totalComp);
  document.getElementById('totalRetorno').textContent = formatBRL(totalRet);
  document.getElementById('totalGanho').textContent = formatBRL(totalGain);
  saveState();
  log(`‚úÖ ${ops.length} opera√ß√µes exibidas em ${dias.length} dias.`);
}

function formatDateForDisplay(s){
  if(!s) return '-';
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)){ const [y,m,d]=s.split('-'); return `${d}/${m}/${y}`; }
  const d = new Date(s);
  if(!isNaN(d)) return d.toLocaleDateString('pt-BR');
  return s;
}

function exportToExcel(){
  if(!operacoes || operacoes.length===0){ log('Nenhuma opera√ß√£o para exportar.'); return; }
  const headerMap = { data:'Data', descricao:'Descri√ß√£o', banco:'Banco', contaCedente:'Conta Cedente', contaCessionario:'Conta Cession√°rio', compromissada:'Compromissada', retorno:'Retorno Bruto', cdiTaxa:'Taxa CDI', puIda:'PU IDA', puVolta:'PU VOLTA' };
  const exportData = operacoes.map(op=>{
    return {
      [headerMap.data]: formatDateForDisplay(op.data),
      [headerMap.descricao]: op.descricao,
      [headerMap.banco]: op.banco,
      [headerMap.contaCedente]: op.contaCedente,
      [headerMap.contaCessionario]: op.contaCessionario,
      [headerMap.compromissada]: op.compromissada,
      [headerMap.retorno]: op.retorno,
      [headerMap.cdiTaxa]: op.cdiTaxa || '',
      [headerMap.puIda]: op.puIda || '',
      [headerMap.puVolta]: op.puVolta || ''
    };
  });
  const ws = XLSX.utils.json_to_sheet(exportData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Dados');
  XLSX.writeFile(wb, 'Conferencia_CDI_'+ new Date().toLocaleDateString('pt-BR').replace(/\//g,'-') + '.xlsx');
  log('‚úÖ Export conclu√≠do.');
}

/* ---------------- Initialize / load local ---------------- */
function init(){
  // load local saved state if any
  try{
    const s = localStorage.getItem('cdiControlState');
    if(s){
      const st = JSON.parse(s);
      operacoes = st.operacoes || [];
      log(`‚ö†Ô∏è Carregando dados locais (${operacoes.length} opera√ß√µes). Fa√ßa login para salvar na nuvem.`);
    } else {
      log('Aguardando... N√£o h√° dados salvos localmente.');
    }
  }catch(e){ operacoes=[]; log('Erro carregar local: '+e.message) }
  calculateAndRender();
}
init();
</script>
</body>
</html>
